---
title: ASP.NET Core データ保護
author: rick-anderson
description: データ保護の概念と ASP.NET Core データ保護 Api の設計原則について説明します。
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/introduction
ms.openlocfilehash: a49eee89e8c11b26c76ba167215c141482159933
ms.sourcegitcommit: c684eb6c0999d11d19e15e65939e5c7f99ba47df
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/19/2018
ms.locfileid: "46292298"
---
# <a name="aspnet-core-data-protection"></a><span data-ttu-id="3ae6d-103">ASP.NET Core データ保護</span><span class="sxs-lookup"><span data-stu-id="3ae6d-103">ASP.NET Core Data Protection</span></span>

<span data-ttu-id="3ae6d-104">多くの場合、web アプリケーションは、機密データを格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-104">Web applications often need to store security-sensitive data.</span></span> <span data-ttu-id="3ae6d-105">Windows デスクトップ アプリケーションの DPAPI を提供しますが、これは web アプリケーションに適したではありません。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-105">Windows provides DPAPI for desktop applications but this is unsuitable for web applications.</span></span> <span data-ttu-id="3ae6d-106">ASP.NET Core データ保護スタックは、単純な使いやすい暗号化の API が開発者キー管理とローテーションをなど、データの保護を使用することができますを提供します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-106">The ASP.NET Core data protection stack provide a simple, easy to use cryptographic API a developer can use to protect data, including key management and rotation.</span></span>

<span data-ttu-id="3ae6d-107">ASP.NET Core データ保護スタックが長期にわたって置き換えとして機能するように設計、 &lt;machineKey&gt; ASP.NET 内の要素の 1.x 4.x です。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-107">The ASP.NET Core data protection stack is designed to serve as the long-term replacement for the &lt;machineKey&gt; element in ASP.NET 1.x - 4.x.</span></span> <span data-ttu-id="3ae6d-108">これは、ほとんどのユース ケースが最新のアプリケーションが発生する可能性があるため、ボックスのソリューションを提供しますが、古い暗号化スタックの欠点の多くに対処する設計されました。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-108">It was designed to address many of the shortcomings of the old cryptographic stack while providing an out-of-the-box solution for the majority of use cases modern applications are likely to encounter.</span></span>

## <a name="problem-statement"></a><span data-ttu-id="3ae6d-109">問題の説明</span><span class="sxs-lookup"><span data-stu-id="3ae6d-109">Problem statement</span></span>

<span data-ttu-id="3ae6d-110">全体的な問題ステートメントは 1 つの文で簡潔に記述できます。 後で取得は、信頼できる情報を保持する必要がありますが、永続化メカニズムを信頼しません。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-110">The overall problem statement can be succinctly stated in a single sentence: I need to persist trusted information for later retrieval, but I don't trust the persistence mechanism.</span></span> <span data-ttu-id="3ae6d-111">Web には、これが書き込む「必要な信頼されていないクライアント経由でのラウンドト リップの信頼された状態にします」</span><span class="sxs-lookup"><span data-stu-id="3ae6d-111">In web terms, this might be written as "I need to round-trip trusted state via an untrusted client."</span></span>

<span data-ttu-id="3ae6d-112">この標準的な例は、認証 cookie またはベアラー トークンです。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-112">The canonical example of this is an authentication cookie or bearer token.</span></span> <span data-ttu-id="3ae6d-113">サーバーを生成、"Groot いて、xyz のアクセス許可がある"トークンし、クライアントに渡すことです。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-113">The server generates an "I am Groot and have xyz permissions" token and hands it to the client.</span></span> <span data-ttu-id="3ae6d-114">いくつかの将来の日付で、クライアントが、サーバーにそのトークンを提示しますが、サーバーがある種のクライアントがトークンを偽造されていないことを保証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-114">At some future date the client will present that token back to the server, but the server needs some kind of assurance that the client hasn't forged the token.</span></span> <span data-ttu-id="3ae6d-115">したがって、最初の要件: 信頼性 (別名。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-115">Thus the first requirement: authenticity (a.k.a.</span></span> <span data-ttu-id="3ae6d-116">整合性、改ざんから)。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-116">integrity, tamper-proofing).</span></span>

<span data-ttu-id="3ae6d-117">永続化の状態は、サーバーによって信頼されて、ために、この状態で運用環境に固有の情報が含まれることが予想されます。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-117">Since the persisted state is trusted by the server, we anticipate that this state might contain information that's specific to the operating environment.</span></span> <span data-ttu-id="3ae6d-118">ファイルのパスをアクセス許可をハンドル、またはその他の間接参照のフォームまたは他の一部のサーバーに固有のデータになります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-118">This could be in the form of a file path, a permission, a handle or other indirect reference, or some other piece of server-specific data.</span></span> <span data-ttu-id="3ae6d-119">このような情報一般に公開すべき、信頼されていないクライアントにします。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-119">Such information should generally not be disclosed to an untrusted client.</span></span> <span data-ttu-id="3ae6d-120">したがって、2 番目の要件: 機密性。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-120">Thus the second requirement: confidentiality.</span></span>

<span data-ttu-id="3ae6d-121">最後に、ため最新のアプリケーションがコンポーネント化、おさらいは個々 のコンポーネントは、システム内の他のコンポーネントに関係なく、このシステムを利用するでしょう。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-121">Finally, since modern applications are componentized, what we've seen is that individual components will want to take advantage of this system without regard to other components in the system.</span></span> <span data-ttu-id="3ae6d-122">たとえば、ベアラー トークンのコンポーネントは、このスタックで使用されている場合は可能性があります、同じスタックを使用することもある CSRF 対策機構から競合することがなく動作する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-122">For instance, if a bearer token component is using this stack, it should operate without interference from an anti-CSRF mechanism that might also be using the same stack.</span></span> <span data-ttu-id="3ae6d-123">したがって最終的な要件: 分離します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-123">Thus the final requirement: isolation.</span></span>

<span data-ttu-id="3ae6d-124">提供できますさらに制約、要件の範囲を限定するためにします。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-124">We can provide further constraints in order to narrow the scope of our requirements.</span></span> <span data-ttu-id="3ae6d-125">暗号方式の範囲内で動作するすべてのサービスが平等に信頼されているし、データが生成または、直接の管理下にあるサービスの外部で使用する必要があることを仮定します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-125">We assume that all services operating within the cryptosystem are equally trusted and that the data doesn't need to be generated or consumed outside of the services under our direct control.</span></span> <span data-ttu-id="3ae6d-126">さらに、web サービスへの各要求を暗号方式 1 回以上移行するための操作ができるだけ高速である必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-126">Furthermore, we require that operations are as fast as possible since each request to the web service might go through the cryptosystem one or more times.</span></span> <span data-ttu-id="3ae6d-127">これにより、対称暗号化は、ここでは、最適となど、必要な時間まで非対称暗号化方式を割引います。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-127">This makes symmetric cryptography ideal for our scenario, and we can discount asymmetric cryptography until such a time that it's needed.</span></span>

## <a name="design-philosophy"></a><span data-ttu-id="3ae6d-128">デザインの理念</span><span class="sxs-lookup"><span data-stu-id="3ae6d-128">Design philosophy</span></span>

<span data-ttu-id="3ae6d-129">既存のスタックの問題を識別することによって開始されています。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-129">We started by identifying problems with the existing stack.</span></span> <span data-ttu-id="3ae6d-130">後で既存のソリューションのランドス ケープを対象し、した、既存のソリューション非常になかった検索機能を終了しました。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-130">Once we had that, we surveyed the landscape of existing solutions and concluded that no existing solution quite had the capabilities we sought.</span></span> <span data-ttu-id="3ae6d-131">ここには、いくつかの基本原則に基づいてソリューションを設計されています。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-131">We then engineered a solution based on several guiding principles.</span></span>

* <span data-ttu-id="3ae6d-132">システムでは、わかりやすくするための構成を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-132">The system should offer simplicity of configuration.</span></span> <span data-ttu-id="3ae6d-133">システム構成になり、開発者がスムーズに理想的です。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-133">Ideally the system would be zero-configuration and developers could hit the ground running.</span></span> <span data-ttu-id="3ae6d-134">開発者が (キーのリポジトリ) などの特定の側面を構成する必要がある場合、これら特定の構成を簡単に行うに考慮対象としてを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-134">In situations where developers need to configure a specific aspect (such as the key repository), consideration should be given to making those specific configurations simple.</span></span>

* <span data-ttu-id="3ae6d-135">単純なコンシューマー向けの API を提供します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-135">Offer a simple consumer-facing API.</span></span> <span data-ttu-id="3ae6d-136">Api を正しく使用する簡単かつ正しく使用するが困難になります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-136">The APIs should be easy to use correctly and difficult to use incorrectly.</span></span>

* <span data-ttu-id="3ae6d-137">開発者は、キー管理の原則について説明します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-137">Developers shouldn't learn key management principles.</span></span> <span data-ttu-id="3ae6d-138">システムには、アルゴリズムの選択と、開発者の代わりにキーの有効期間を処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-138">The system should handle algorithm selection and key lifetime on the developer's behalf.</span></span> <span data-ttu-id="3ae6d-139">理想的には、開発者は、生のキー マテリアルへのアクセスをすらが必要です。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-139">Ideally the developer should never even have access to the raw key material.</span></span>

* <span data-ttu-id="3ae6d-140">可能であれば rest でキーを保護する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-140">Keys should be protected at rest when possible.</span></span> <span data-ttu-id="3ae6d-141">システムは、適切な既定の保護メカニズムを確認し、自動的に適用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-141">The system should figure out an appropriate default protection mechanism and apply it automatically.</span></span>

<span data-ttu-id="3ae6d-142">これらの原則を念頭に、単純なを開発した[使いやすい](xref:security/data-protection/using-data-protection)データ保護スタック。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-142">With these principles in mind we developed a simple, [easy to use](xref:security/data-protection/using-data-protection) data protection stack.</span></span>

<span data-ttu-id="3ae6d-143">ASP.NET Core データ保護 Api が機密のペイロードの無期限の永続化の主に意図されていません。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-143">The ASP.NET Core data protection APIs are not primarily intended for indefinite persistence of confidential payloads.</span></span> <span data-ttu-id="3ae6d-144">などの他のテクノロジ[Windows CNG DPAPI](https://msdn.microsoft.com/library/windows/desktop/hh706794%28v=vs.85%29.aspx)と[Azure Rights Management](https://docs.microsoft.com/rights-management/)無制限のストレージのシナリオに適したこれに応じて拡大縮小の強力なキー管理機能があるとします。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-144">Other technologies like [Windows CNG DPAPI](https://msdn.microsoft.com/library/windows/desktop/hh706794%28v=vs.85%29.aspx) and [Azure Rights Management](https://docs.microsoft.com/rights-management/) are more suited to the scenario of indefinite storage, and they have correspondingly strong key management capabilities.</span></span> <span data-ttu-id="3ae6d-145">ただし、機密データの長期的な保護の ASP.NET Core データ保護 Api を使用してから、開発者を禁止すること何もないです。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-145">That said, there's nothing prohibiting a developer from using the ASP.NET Core data protection APIs for long-term protection of confidential data.</span></span>

## <a name="audience"></a><span data-ttu-id="3ae6d-146">対象ユーザー</span><span class="sxs-lookup"><span data-stu-id="3ae6d-146">Audience</span></span>

<span data-ttu-id="3ae6d-147">データ保護システムは、5 つのメイン パッケージに分割されます。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-147">The data protection system is divided into five main packages.</span></span> <span data-ttu-id="3ae6d-148">これらの Api のさまざまなターゲットの 3 つの主な対象ユーザー。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-148">Various aspects of these APIs target three main audiences;</span></span>

1. <span data-ttu-id="3ae6d-149">[コンシューマー Api の概要](xref:security/data-protection/consumer-apis/overview)アプリケーションとフレームワークの開発者を対象します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-149">The [Consumer APIs Overview](xref:security/data-protection/consumer-apis/overview) target application and framework developers.</span></span>

   <span data-ttu-id="3ae6d-150">"しないスタックの動作方法について、またはを構成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-150">"I don't want to learn about how the stack operates or about how it's configured.</span></span> <span data-ttu-id="3ae6d-151">単純にする Api を正常に使用する可能性が高いできるだけ単純になんらかの操作方法を実行します。"</span><span class="sxs-lookup"><span data-stu-id="3ae6d-151">I simply want to perform some operation in as simple a manner as possible with high probability of using the APIs successfully."</span></span>

2. <span data-ttu-id="3ae6d-152">[構成 Api](xref:security/data-protection/configuration/overview)アプリケーション開発者およびシステム管理者を対象します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-152">The [configuration APIs](xref:security/data-protection/configuration/overview) target application developers and system administrators.</span></span>

   <span data-ttu-id="3ae6d-153">「必要がありますに自分の環境には、既定以外のパスや設定が必要であるデータ保護システムに指示します。」</span><span class="sxs-lookup"><span data-stu-id="3ae6d-153">"I need to tell the data protection system that my environment requires non-default paths or settings."</span></span>

3. <span data-ttu-id="3ae6d-154">カスタム ポリシーの実装を担当 Api 対象の機能拡張開発者。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-154">The extensibility APIs target developers in charge of implementing custom policy.</span></span> <span data-ttu-id="3ae6d-155">これらの Api の使用状況はまれな状況に限定し、が発生した、セキュリティ対応の開発者は。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-155">Usage of these APIs would be limited to rare situations and experienced, security aware developers.</span></span>

   <span data-ttu-id="3ae6d-156">"本当に固有の動作要件があるため、システム内でコンポーネント全体を置換する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-156">"I need to replace an entire component within the system because I have truly unique behavioral requirements.</span></span> <span data-ttu-id="3ae6d-157">私は自分の要件を満たしているプラグインを構築するために、API サーフェスのことに使用される部分を学習する意欲。"</span><span class="sxs-lookup"><span data-stu-id="3ae6d-157">I am willing to learn uncommonly-used parts of the API surface in order to build a plugin that fulfills my requirements."</span></span>

## <a name="package-layout"></a><span data-ttu-id="3ae6d-158">パッケージのレイアウト</span><span class="sxs-lookup"><span data-stu-id="3ae6d-158">Package layout</span></span>

<span data-ttu-id="3ae6d-159">データ保護スタックは、5 つのパッケージで構成されます。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-159">The data protection stack consists of five packages.</span></span>

* <span data-ttu-id="3ae6d-160">[Microsoft.AspNetCore.DataProtection.Abstractions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Abstractions/)が含まれています、<xref:Microsoft.AspNetCore.DataProtection.IDataProtectionProvider>と<xref:Microsoft.AspNetCore.DataProtection.IDataProtector>データ保護サービスを作成するインターフェイス。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-160">[Microsoft.AspNetCore.DataProtection.Abstractions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Abstractions/) contains the <xref:Microsoft.AspNetCore.DataProtection.IDataProtectionProvider> and <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> interfaces to create data protection services.</span></span> <span data-ttu-id="3ae6d-161">これらの型を操作するための便利な拡張メソッドも含まれています (たとえば、 [IDataProtector.Protect](xref:Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Protect*))。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-161">It also contains useful extension methods for working with these types (for example, [IDataProtector.Protect](xref:Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Protect*)).</span></span> <span data-ttu-id="3ae6d-162">データ保護システムが他の場所でインスタンス化された API を使用している場合は、参照`Microsoft.AspNetCore.DataProtection.Abstractions`します。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-162">If the data protection system is instantiated elsewhere and you're consuming the API, reference `Microsoft.AspNetCore.DataProtection.Abstractions`.</span></span>

* <span data-ttu-id="3ae6d-163">[Microsoft.AspNetCore.DataProtection](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection/)コア暗号化操作、キー管理、構成、および機能拡張を含む、データ保護システムのコア実装が含まれています。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-163">[Microsoft.AspNetCore.DataProtection](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection/) contains the core implementation of the data protection system, including core cryptographic operations, key management, configuration, and extensibility.</span></span> <span data-ttu-id="3ae6d-164">データ保護システムをインスタンス化する (たとえば、追加することを<xref:Microsoft.Extensions.DependencyInjection.IServiceCollection>) 変更、またはその動作を拡張するを参照または`Microsoft.AspNetCore.DataProtection`。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-164">To instantiate the data protection system (for example, adding it to an <xref:Microsoft.Extensions.DependencyInjection.IServiceCollection>) or modifying or extending its behavior, reference `Microsoft.AspNetCore.DataProtection`.</span></span>

* <span data-ttu-id="3ae6d-165">[Microsoft.AspNetCore.DataProtection.Extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/)開発者が役に立つ場合がありますが、コア パッケージに属することはありませんが、追加の Api が含まれています。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-165">[Microsoft.AspNetCore.DataProtection.Extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/) contains additional APIs which developers might find useful but which don't belong in the core package.</span></span> <span data-ttu-id="3ae6d-166">たとえば、このパッケージが依存関係の挿入せず、ファイル システム上の場所にキーを格納するデータ保護システムのインスタンスを作成するファクトリ メソッドが含まれます (を参照してください<xref:Microsoft.AspNetCore.DataProtection.DataProtectionProvider>)。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-166">For instance, this package contains factory methods to instantiate the data protection system to store keys at a location on the file system without dependency injection (see <xref:Microsoft.AspNetCore.DataProtection.DataProtectionProvider>).</span></span> <span data-ttu-id="3ae6d-167">保護されたペイロードの有効期間を制限するための拡張メソッドも含まれています (を参照してください<xref:Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector>)。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-167">It also contains extension methods for limiting the lifetime of protected payloads (see <xref:Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector>).</span></span>

* <span data-ttu-id="3ae6d-168">[Microsoft.AspNetCore.DataProtection.SystemWeb](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.SystemWeb/)をリダイレクトする既存の ASP.NET 4.x アプリケーションをインストールすることができます、`<machineKey>`新しい ASP.NET Core データ保護スタックを使用する操作。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-168">[Microsoft.AspNetCore.DataProtection.SystemWeb](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.SystemWeb/) can be installed into an existing ASP.NET 4.x app to redirect its `<machineKey>` operations to use the new ASP.NET Core data protection stack.</span></span> <span data-ttu-id="3ae6d-169">詳細については、「<xref:security/data-protection/compatibility/replacing-machinekey>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-169">For more information, see <xref:security/data-protection/compatibility/replacing-machinekey>.</span></span>

* <span data-ttu-id="3ae6d-170">[Microsoft.AspNetCore.Cryptography.KeyDerivation](https://www.nuget.org/packages/Microsoft.AspNetCore.Cryptography.KeyDerivation/) PBKDF2 パスワード ハッシュのルーチンの実装を提供しがユーザーのパスワードを安全に処理するシステムで使用できます。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-170">[Microsoft.AspNetCore.Cryptography.KeyDerivation](https://www.nuget.org/packages/Microsoft.AspNetCore.Cryptography.KeyDerivation/) provides an implementation of the PBKDF2 password hashing routine and can be used by systems that must handle user passwords securely.</span></span> <span data-ttu-id="3ae6d-171">詳細については、「<xref:security/data-protection/consumer-apis/password-hashing>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="3ae6d-171">For more information, see <xref:security/data-protection/consumer-apis/password-hashing>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="3ae6d-172">その他の技術情報</span><span class="sxs-lookup"><span data-stu-id="3ae6d-172">Additional resources</span></span>

<xref:host-and-deploy/web-farm>
