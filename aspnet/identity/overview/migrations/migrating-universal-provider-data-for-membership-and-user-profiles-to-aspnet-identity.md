---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: メンバーシップと ASP.NET Identity (c#) するユーザー プロファイル用のユニバーサル プロバイダーにデータの移行 |Microsoft ドキュメント
author: rustd
description: このチュートリアルでは、ユーザーおよびロールのデータと、既存アプリのユニバーサル プロバイダーを使用して作成されたユーザー プロファイル データを移行するために必要な手順について説明しています.
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/13/2013
ms.topic: article
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 75d273d9fdb5d8ff0f7a910f42abe8bcce6e397d
ms.sourcegitcommit: e22097b84d26a812cd1380a6b2d12c93e522c125
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/22/2018
ms.locfileid: "36314001"
---
<a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="7d94f-103">メンバーシップと ASP.NET Identity (c#) するユーザー プロファイル用のユニバーサル プロバイダー データの移行</span><span class="sxs-lookup"><span data-stu-id="7d94f-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="7d94f-104">によって[Pranav Rastogi](https://github.com/rustd)、 [Rick Anderson](https://github.com/Rick-Anderson)、 [Robert McMurray](https://github.com/rmcmurray)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="7d94f-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="7d94f-105">このチュートリアルでは、ユーザーおよびロールのデータと、ASP.NET Identity モデルに既存のアプリケーションのユニバーサル プロバイダーを使用して作成されたユーザー プロファイル データを移行するために必要な手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="7d94f-106">ここで説明した方法はユーザー プロファイル データを移行すると、SQL のメンバーシップも使用してアプリケーションで使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>


<span data-ttu-id="7d94f-107">Visual Studio 2013 のリリースで ASP.NET チームは、新しい ASP.NET Id システムを導入し、詳細を読み取ることができます、リリースに関する[ここ](../../index.md)です。</span><span class="sxs-lookup"><span data-stu-id="7d94f-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="7d94f-108">Web アプリケーションを移行するには、そのアーティクルでフォロー アップ[新しい Id システムに SQL メンバーシップ](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)、この記事は、次のユーザーとロール管理のためのプロバイダー モデルを既存のアプリケーションを移行する手順を示しています。新しい Identity モデル。</span><span class="sxs-lookup"><span data-stu-id="7d94f-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="7d94f-109">このチュートリアルの焦点は、シームレスにそれを新しいシステムにフックするユーザー プロファイル データを移行する方法、主になります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="7d94f-110">移行するユーザーおよびロールの詳細については、SQL メンバーシップ用に似ています。</span><span class="sxs-lookup"><span data-stu-id="7d94f-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="7d94f-111">プロファイル データの移行に書き込み、続けてアプローチは、SQL のメンバーシップも使用してアプリケーションで使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="7d94f-112">たとえば、プロバイダー モデルを使用する Visual Studio 2012 を使用して作成された web アプリを開始します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="7d94f-113">おをプロファイルの管理にコードを追加、ユーザーを登録、ユーザーのプロファイル データを追加する、データベース スキーマを移行し、ユーザーおよびロールの管理に Id システムを使用するアプリケーションを変更します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="7d94f-114">移行のテストとして Universal Providers を使用して作成できる必要がありますにログインして新しいユーザーを登録することにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="7d94f-115">完全なサンプルを見つけることができます[ https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations)です。</span><span class="sxs-lookup"><span data-stu-id="7d94f-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>


## <a name="profile-data-migration-summary"></a><span data-ttu-id="7d94f-116">プロファイル データの移行の概要</span><span class="sxs-lookup"><span data-stu-id="7d94f-116">Profile data migration summary</span></span>

<span data-ttu-id="7d94f-117">以降、移行では、前にプロバイダー モデルでプロファイル データを格納する場合の動作について見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="7d94f-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="7d94f-118">ユーザーは、複数の方法で格納できるアプリケーションのプロファイル データ、それらの間で最も一般的なされているプロバイダーを使用して、組み込みのプロファイル Universal Providers と共に出荷します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="7d94f-119">手順が含まれます</span><span class="sxs-lookup"><span data-stu-id="7d94f-119">The steps would include</span></span>

1. <span data-ttu-id="7d94f-120">プロファイル データを格納するためのプロパティを持つクラスを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="7d94f-121">'ProfileBase' を拡張し、ユーザーの上記のプロファイル データを取得するメソッドを実装するクラスを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="7d94f-122">既定のプロファイル プロバイダーを使用して有効にする、 *web.config*ファイルし、プロファイル情報へのアクセスに使用される 2 の手順で宣言されたクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="7d94f-123">プロファイル情報は、シリアル化された xml と、データベース内の 'プロファイル' テーブル内のバイナリ データとして格納されます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="7d94f-124">新しい ASP.NET Id システムを使用するアプリケーションを移行した後、プロファイル情報が逆シリアル化し、ユーザー クラスのプロパティとして格納します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="7d94f-125">各プロパティは、ユーザー テーブル内の列にマップできます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="7d94f-126">プロパティをデータの情報をシリアル化/逆シリアル化する必要がないだけでなく、ユーザー クラスを使用して直接に作業できることの利点は、アクセスするときの時刻します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="7d94f-127">作業の開始</span><span class="sxs-lookup"><span data-stu-id="7d94f-127">Getting Started</span></span>

1. <span data-ttu-id="7d94f-128">Visual Studio 2012 では、新しい ASP.NET 4.5 Web フォーム アプリケーションを作成します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="7d94f-129">現在のサンプルが Web フォーム テンプレートを使用しますが、MVC アプリケーションにも使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="7d94f-130">'モデル' プロファイル情報を格納する新しいフォルダーを作成します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="7d94f-131">例として、プロファイルに生年月日、市区町村、高さ、ユーザーの重みの日付を格納お知らせします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="7d94f-132">幅と高さは、'PersonalStats' と呼ばれるカスタム クラスとして格納されます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="7d94f-133">保存して、プロファイルを取得、'ProfileBase' を拡張するクラスが必要です。</span><span class="sxs-lookup"><span data-stu-id="7d94f-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="7d94f-134">新しいクラスを取得し、プロファイル情報を格納するには、' AppProfile' を作成してみましょう。</span><span class="sxs-lookup"><span data-stu-id="7d94f-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="7d94f-135">プロファイルを有効にする、 *web.config*ファイル。</span><span class="sxs-lookup"><span data-stu-id="7d94f-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="7d94f-136">手順 3 で作成したユーザーの情報を格納および取得するために使用するクラス名を入力します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="7d94f-137">ユーザーのプロファイル データを取得し、保存 'Account' フォルダー内には、web フォーム ページを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="7d94f-138">プロジェクトを右クリックし、新しい項目の追加 を選択します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="7d94f-139">マスター ページ 'AddProfileData.aspx' で新しい webforms ページを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="7d94f-140">'メイン' セクションで、次をコピーします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="7d94f-141">分離コードで、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="7d94f-142">コンパイル エラーを削除するどの AppProfile 下にあるクラスが定義されている名前空間を追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="7d94f-143">アプリを実行して、ユーザー名を持つ新しいユーザーの作成 '**olduser' です。**</span><span class="sxs-lookup"><span data-stu-id="7d94f-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="7d94f-144">'AddProfileData' のページに移動し、ユーザーのプロファイル情報を追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="7d94f-145">サーバー エクスプ ローラー ウィンドウを使用して 'プロファイル' テーブルのシリアル化された xml としてデータが格納されていることを確認することができます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="7d94f-146">Visual Studio で、表示 メニューから ' サーバー エクスプ ローラー を選択します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="7d94f-147">定義されているデータベースのデータ接続が存在する必要があります、 *web.config*ファイル。</span><span class="sxs-lookup"><span data-stu-id="7d94f-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="7d94f-148">データ接続をクリックすると、別のサブ カテゴリを示します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="7d94f-149">データベースで別のテーブルを表示し、'プロファイル' を右クリックし、プロファイル テーブルに格納されているプロファイル データを表示する ' テーブル データの表示 ' を選択するには、' テーブル' を展開します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="7d94f-150">データベース スキーマを移行します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-150">Migrating database schema</span></span>

<span data-ttu-id="7d94f-151">Id システムを使用する既存のデータベースにするには、元のデータベースに追加したフィールドをサポートするためにユーザー データベースでスキーマを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="7d94f-152">これを行う SQL スクリプトを使用する新しいテーブルを作成し、既存の情報をコピーします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="7d94f-153">' [サーバー エクスプ ローラー] ウィンドウで、テーブルを表示する 'DefaultConnection' を展開します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="7d94f-154">テーブルを右クリックし、[新規クエリ] を選択</span><span class="sxs-lookup"><span data-stu-id="7d94f-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="7d94f-155">SQL スクリプトを貼り付けます[ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)し実行します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="7d94f-156">'DefaultConnection' が更新される場合は、新しいテーブルが追加されたことを確認できます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="7d94f-157">情報が移行されたことを確認するテーブル内のデータを確認することができます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="7d94f-158">ASP.NET の Id を使用するアプリケーションへの移行</span><span class="sxs-lookup"><span data-stu-id="7d94f-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="7d94f-159">ASP.NET Identity の必要な Nuget パッケージをインストールします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="7d94f-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="7d94f-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="7d94f-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="7d94f-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="7d94f-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="7d94f-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="7d94f-163">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="7d94f-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="7d94f-164">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="7d94f-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="7d94f-165">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="7d94f-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="7d94f-166">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="7d94f-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="7d94f-167">Nuget パッケージの管理の詳細についてを参照できます[ここ](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span><span class="sxs-lookup"><span data-stu-id="7d94f-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="7d94f-168">テーブル内の既存のデータを操作するには、テーブルにマップされ、Id システムにフック モデル クラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="7d94f-169">Identity コントラクトの一部として、モデル クラスは Identity.Core dll で定義されているインターフェイスを実装する必要がありますか、または Microsoft.AspNet.Identity.EntityFramework で利用できるこれらのインターフェイスの既存の実装を拡張することができます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="7d94f-170">使用する既存のクラスの役割、ユーザーのログインおよびユーザーの信頼性情報のです。</span><span class="sxs-lookup"><span data-stu-id="7d94f-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="7d94f-171">このサンプルのカスタム ユーザーを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="7d94f-172">プロジェクトを右クリックし、新しいフォルダー 'IdentityModels' を作成します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="7d94f-173">次に示すように、新しい 'User' クラスを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="7d94f-174">'ProfileInfo' が、ユーザー クラスのプロパティになったことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="7d94f-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="7d94f-175">そのためのプロファイル データを直接操作するユーザー クラスを使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d94f-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="7d94f-176">内のファイルをコピー、 **IdentityModels**と**IdentityAccount**ダウンロード元のフォルダー ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) )。</span><span class="sxs-lookup"><span data-stu-id="7d94f-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="7d94f-177">これらは、残りのモデル クラスおよびユーザーと、ASP.NET Identity の Api を使用してロールの管理に必要な新しいページがあります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="7d94f-178">使用されている方法は、SQL メンバーシップに似ており、詳細についてを参照して[ここ](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)です。</span><span class="sxs-lookup"><span data-stu-id="7d94f-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="7d94f-179">新しいテーブルにプロファイル データのコピー</span><span class="sxs-lookup"><span data-stu-id="7d94f-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="7d94f-180">前述のように、プロファイル テーブル内の xml データを逆シリアル化し、AspNetUsers テーブルの列に格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="7d94f-181">新しい列は、ため、これらの列に必要なデータを設定することですが、残っているすべて前の手順で、ユーザー テーブルで作成されました。</span><span class="sxs-lookup"><span data-stu-id="7d94f-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="7d94f-182">これを行うには、ユーザー テーブルに新しく作成された列の設定に 1 回実行され、コンソール アプリケーションを使用します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="7d94f-183">既存のソリューションに新しいコンソール アプリケーションを作成します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="7d94f-184">Entity Framework パッケージの最新バージョンをインストールします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="7d94f-185">コンソール アプリケーションへの参照として上記で作成した web アプリケーションを追加します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="7d94f-186">行うにはこのプロジェクトを右クリック、し、' 参照の追加 ' で、ソリューション、プロジェクトをクリックし、[ok] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="7d94f-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="7d94f-187">コピー、Program.cs クラスのコードの下。</span><span class="sxs-lookup"><span data-stu-id="7d94f-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="7d94f-188">このロジックは、'ProfileInfo' のオブジェクトとしてシリアル化して、およびデータベースに格納する各ユーザーのプロファイル データを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="7d94f-189">使用モデルの一部は定義されて、web アプリケーション プロジェクトの 'IdentityModels' フォルダーにため、対応する名前空間を含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="7d94f-190">上記のコードは、アプリ内のデータベース ファイルで動作\_前の手順で、web アプリケーション プロジェクトのデータ フォルダーを作成します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="7d94f-191">それを参照するには、web アプリケーションの web.config に接続文字列で、コンソール アプリケーションの app.config ファイル内の接続文字列を更新します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="7d94f-192">また、'AttachDbFilename' プロパティに完全な物理パスを提供します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="7d94f-193">コマンド プロンプトを開き、上記のコンソール アプリケーションの bin フォルダーに移動します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="7d94f-194">実行可能ファイルを実行し、次の図のように、ログの出力を確認します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="7d94f-195">サーバー エクスプ ローラーで 'AspNetUsers' テーブルを開き、プロパティを保持する新しい列のデータを確認します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="7d94f-196">対応するプロパティ値で更新される必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="7d94f-197">機能を確認します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-197">Verify functionality</span></span>

<span data-ttu-id="7d94f-198">古いデータベースからユーザーをログインに ASP.NET の Id を使用して実装されている、新しく追加されたメンバーシップ ページを使用します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="7d94f-199">ユーザーは、同じ資格情報を使用してログインできる必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="7d94f-200">ユーザーをロールなどを追加する OAuth など、パスワードの変更、新しいユーザーを作成するの役割の追加の追加などの他の機能を実行してください。</span><span class="sxs-lookup"><span data-stu-id="7d94f-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="7d94f-201">古いユーザーと新しいユーザーのプロファイル データが取得され、ユーザー テーブルに格納されるべきです。</span><span class="sxs-lookup"><span data-stu-id="7d94f-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="7d94f-202">古いテーブルを参照できなくする必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d94f-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="7d94f-203">まとめ</span><span class="sxs-lookup"><span data-stu-id="7d94f-203">Conclusion</span></span>

<span data-ttu-id="7d94f-204">アーティクルでは、ASP.NET Identity のメンバーシップのプロバイダー モデルを使用する web アプリケーションの移行のプロセスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="7d94f-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="7d94f-205">さらに、アーティクルには、Id システムにフックするユーザーのプロファイル データの移行が記載されています。</span><span class="sxs-lookup"><span data-stu-id="7d94f-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="7d94f-206">以下の質問と、アプリを移行するときに発生した問題のコメントを入力してください。</span><span class="sxs-lookup"><span data-stu-id="7d94f-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="7d94f-207">*Rick Anderson および Robert McMurray、記事のレビューいただきありがとうございます。*</span><span class="sxs-lookup"><span data-stu-id="7d94f-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
