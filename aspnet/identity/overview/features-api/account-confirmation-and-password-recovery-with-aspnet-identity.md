---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: アカウントの確認とパスワードの回復では、ASP.NET Identity (c#) |Microsoft Docs
author: HaoK
description: このチュートリアルを完了する必要がありますを実行する前に、ログイン、電子メールの確認とパスワードのリセットをセキュリティで保護された ASP.NET MVC 5 web アプリを作成します。 このチュートリアルには.
ms.author: riande
ms.date: 03/26/2015
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 77a3e9d5e8b2698d2464e33520d779febd4533bd
ms.sourcegitcommit: 45ac74e400f9f2b7dbded66297730f6f14a4eb25
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/16/2018
ms.locfileid: "41829941"
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="0e48e-104">アカウントの確認とパスワードの回復では、ASP.NET Identity (c#)</span><span class="sxs-lookup"><span data-stu-id="0e48e-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="0e48e-105">によって[Hao 力](https://github.com/HaoK)、 [Pranav Rastogi](https://github.com/rustd)、 [Rick Anderson](https://github.com/Rick-Anderson)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="0e48e-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="0e48e-106">このチュートリアルを実行する前に行う必要がありますまず[ログイン、電子メールの確認とパスワードのリセットをセキュリティで保護された ASP.NET MVC 5 web アプリを作成する](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="0e48e-107">このチュートリアルでは、詳細が含まれていて、ローカル アカウントの確認の電子メールを設定し、ASP.NET Identity で忘れたパスワードをリセットできるようにする方法が表示されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="0e48e-108">この記事の執筆者は、Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT))、Pranav Rastogi ([@rustd](https://twitter.com/rustd))、Hao 力、および Suhas Joshi します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="0e48e-109">NuGet のサンプルは、主に Hao 力によって記述されています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="0e48e-110">ローカル ユーザー アカウントが、ユーザー、アカウントのパスワードを作成する必要があり、そのパスワードが、web アプリで (安全に) 格納されています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="0e48e-111">ASP.NET Identity では、ソーシャル アカウントは、アプリのパスワードを作成するユーザーを必要としないこともできます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="0e48e-112">[ソーシャル アカウント](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)(Google、Twitter、Facebook、Microsoft) などのサード パーティを使用してユーザーを認証します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="0e48e-113">このトピックでは、次の項目について説明します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-113">This topic covers the following:</span></span>

- <span data-ttu-id="0e48e-114">[ASP.NET MVC アプリの作成](#createMvc)と ASP.NET Identity 機能を検証します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="0e48e-115">ビルド Id サンプル</span><span class="sxs-lookup"><span data-stu-id="0e48e-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="0e48e-116">確認の電子メール設定します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="0e48e-117">新しいユーザーは、ローカル アカウントを作成します。 電子メールのエイリアスを登録します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="0e48e-118">メール アドレスの検証トークンを含む確認の電子メールを送信する登録 ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="0e48e-119">ユーザーは自分のアカウントの確認トークンを使用して電子メールで送信されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="0e48e-120">リンクをクリックすると、アカウントを確認します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="0e48e-121">パスワード回復/リセット</span><span class="sxs-lookup"><span data-stu-id="0e48e-121">Password recovery/reset</span></span>

<span data-ttu-id="0e48e-122">自分のパスワードを忘れた場合、ローカル ユーザーがパスワードのリセットを有効にするセキュリティ トークンが、電子メール アカウントに送信されることができます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="0e48e-123">ユーザーは、自分のパスワードをリセットできるようにリンクを含む電子メールがすぐされます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="0e48e-124">リンクをクリックしては、リセット ページに移動されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="0e48e-125">クリックすると、**リセット**ボタンは、パスワードがリセットされたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="0e48e-126">ASP.NET Web アプリを作成します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="0e48e-127">インストールと実行によって開始[Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058)または[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="0e48e-128">Visual Studio のインストール[2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)またはそれ以降。</span><span class="sxs-lookup"><span data-stu-id="0e48e-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="0e48e-129">警告: Visual Studio をインストールする必要があります[2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)このチュートリアルを完了します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="0e48e-130">新しい ASP.NET Web プロジェクトを作成し、MVC テンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="0e48e-131">Web フォームには ASP.NET Identity もサポートしていますので、web フォーム アプリで同じ手順を実行できます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="0e48e-132">既定の認証としてのままに**個々 のユーザー アカウント**します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="0e48e-133">アプリを実行し、をクリックして、**登録**リンクし、ユーザーを登録します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="0e48e-134">この時点では、電子メールの検証のみ、 [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性。</span><span class="sxs-lookup"><span data-stu-id="0e48e-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="0e48e-135">サーバー エクスプ ローラーに移動します。**データ Connections\DefaultConnection\Tables\AspNetUsers**を右クリックし、選択**テーブル定義を開く**します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="0e48e-136">次の図は、`AspNetUsers`スキーマ。</span><span class="sxs-lookup"><span data-stu-id="0e48e-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="0e48e-137">右クリックして、 **AspNetUsers**テーブルを選択**テーブル データの表示**します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="0e48e-138">この時点で、電子メールが確認されていません。</span><span class="sxs-lookup"><span data-stu-id="0e48e-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="0e48e-139">ASP.NET Identity の既定のデータ ストアは、Entity Framework が、他のデータ ストアを使用して、フィールドを追加することを構成することができます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="0e48e-140">参照してください[資料](#addRes)このチュートリアルの最後のセクション。</span><span class="sxs-lookup"><span data-stu-id="0e48e-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="0e48e-141">[OWIN startup クラス](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)( *Startup.cs* )、アプリが開始し、呼び出すときに呼び出される、`ConfigureAuth`メソッド*アプリ\_Start\Startup.Auth.cs*、これにより、OWIN パイプラインを構成して、ASP.NET Identity を初期化します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="0e48e-142">`ConfigureAuth` メソッドを調べます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="0e48e-143">各`CreatePerOwinContext`呼び出しコールバックを登録します (に保存されている、 `OwinContext`) 指定した型のインスタンスを作成する要求あたり 1 回呼び出すされます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="0e48e-144">コンス トラクターで、ブレークポイントを設定して`Create`各型のメソッド (`ApplicationDbContext, ApplicationUserManager`) 要求のたびに呼び出されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="0e48e-145">インスタンスを`ApplicationDbContext`と`ApplicationUserManager`アプリケーション全体でアクセスできます。 OWIN コンテキストに格納されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="0e48e-146">ASP.NET Identity では、cookie ミドルウェアを OWIN パイプラインにフックします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="0e48e-147">詳細については、次を参照してください。 [ASP.NET Identity で UserManager クラスの要求の有効期間管理あたり](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="0e48e-148">新しいセキュリティ スタンプが生成されに格納されているセキュリティ プロファイルを変更すると、`SecurityStamp`のフィールド、 *AspNetUsers*テーブル。</span><span class="sxs-lookup"><span data-stu-id="0e48e-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="0e48e-149">メモ、`SecurityStamp`フィールドとは異なるセキュリティ クッキー。</span><span class="sxs-lookup"><span data-stu-id="0e48e-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="0e48e-150">セキュリティ クッキーに格納されていない、`AspNetUsers`テーブル (または任意の場所で Identity DB)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="0e48e-151">使用して、セキュリティ cookie トークンが自己署名[DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)で作成し、`UserId, SecurityStamp`と有効期限の時刻情報。</span><span class="sxs-lookup"><span data-stu-id="0e48e-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="0e48e-152">Cookie ミドルウェアは、各要求の cookie を確認します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="0e48e-153">`SecurityStampValidator`メソッドで、`Startup`クラスが、DB をヒットして、定期的にセキュリティ スタンプをチェックに指定された、`validateInterval`します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="0e48e-154">これは、セキュリティ プロファイルを変更しない限り (サンプル) では 30 分のみ発生します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="0e48e-155">データベースへのトリップを最小限に抑える、30 分間隔が選択されました。</span><span class="sxs-lookup"><span data-stu-id="0e48e-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="0e48e-156">参照してください、 [2 要素認証のチュートリアル](index.md)の詳細。</span><span class="sxs-lookup"><span data-stu-id="0e48e-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="0e48e-157">コードでは、コメント、`UseCookieAuthentication`メソッドは、cookie 認証をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="0e48e-158">`SecurityStamp`フィールドと関連付けられているコードは、強固なセキュリティをアプリは、のパスワードを変更するときにログインする必要がログインに使用したブラウザーから。</span><span class="sxs-lookup"><span data-stu-id="0e48e-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="0e48e-159">`SecurityStampValidator.OnValidateIdentity`メソッドは、パスワードを変更または外部ログインを使用するときに使用される、ユーザーがログインすると、セキュリティ トークンを検証するアプリを使用できます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="0e48e-160">これは、古いパスワードで生成されたトークン (cookie) が無効にすることを確認する必要です。</span><span class="sxs-lookup"><span data-stu-id="0e48e-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="0e48e-161">サンプル プロジェクトで変更した場合のユーザーに対して新しいトークンでは、ユーザーのパスワードが生成された、前のすべてのトークンが無効にし、`SecurityStamp`フィールドが更新されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="0e48e-162">Id システムを許可するアプリを構成するため、ユーザーのセキュリティ プロファイルが変更されたとき (たとえば、ログインが関連付けられたユーザーが自分のパスワードまたは変更を変更する場合 (などで、Facebook、Google、Microsoft アカウントなど)、すべてから、ユーザーがログインブラウザーのインスタンス。</span><span class="sxs-lookup"><span data-stu-id="0e48e-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="0e48e-163">次の画像など、[シングル サインアウトのサンプル](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)アプリ、ユーザーが 1 つのボタンをクリックして (この場合、IE、Firefox、Chrome は) 内のすべてのブラウザー インスタンスからサインアウトします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="0e48e-164">または、サンプルでは、特定のブラウザー インスタンスからログアウトのみできます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="0e48e-165">[シングル サインアウトのサンプル](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)アプリは、ASP.NET Identity を使用すると、セキュリティ トークンの再生成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="0e48e-166">これは、古いパスワードで生成されたトークン (cookie) が無効にすることを確認する必要です。</span><span class="sxs-lookup"><span data-stu-id="0e48e-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="0e48e-167">この機能は、アプリケーションにセキュリティの追加のレイヤーを提供します。パスワードを変更するときに、このアプリケーションにログインした場所にログインされます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="0e48e-168">*アプリ\_Start\IdentityConfig.cs*ファイルが含まれています、 `ApplicationUserManager`、`EmailService`と`SmsService`クラス。</span><span class="sxs-lookup"><span data-stu-id="0e48e-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="0e48e-169">`EmailService`と`SmsService`各実装クラス、`IIdentityMessageService`インターフェイス、電子メールと SMS を構成するには、各クラスに共通のメソッドがあるようにします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="0e48e-170">このチュートリアルを使用して電子メール通知を追加する方法だけでは[SendGrid](http://sendgrid.com/)SMTP とその他のメカニズムを使用して電子メールを送信することができます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="0e48e-171">`Startup`クラスは、ソーシャル ログイン (Facebook、Twitter など) は、拙著のチュートリアルを参照してください。 追加するボイラー プレートも含まれています。 [Facebook、Twitter、LinkedIn、Google の OAuth2 サインオンした MVC 5 アプリケーション](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)の詳細。</span><span class="sxs-lookup"><span data-stu-id="0e48e-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="0e48e-172">確認、`ApplicationUserManager`クラスは、ユーザーの id 情報を含むし、次の機能を構成します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="0e48e-173">パスワードの強度の要件。</span><span class="sxs-lookup"><span data-stu-id="0e48e-173">Password strength requirements.</span></span>
- <span data-ttu-id="0e48e-174">ユーザーのロックアウト (試行と時刻)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="0e48e-175">2 要素認証 (2 fa)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="0e48e-176">別のチュートリアルでは、2 fa と SMS を取り上げる予定です。</span><span class="sxs-lookup"><span data-stu-id="0e48e-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="0e48e-177">電子メールと SMS サービスをフックします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="0e48e-178">(取り上げます SMS 別のチュートリアルでは)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="0e48e-179">`ApplicationUserManager`ジェネリック クラス`UserManager<ApplicationUser>`クラス。</span><span class="sxs-lookup"><span data-stu-id="0e48e-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="0e48e-180">`ApplicationUser` 派生した[IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="0e48e-181">`IdentityUser` ジェネリックから派生した`IdentityUser`クラス。</span><span class="sxs-lookup"><span data-stu-id="0e48e-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="0e48e-182">上記のプロパティのプロパティと一致し、`AspNetUsers`前に示したテーブル。</span><span class="sxs-lookup"><span data-stu-id="0e48e-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="0e48e-183">ジェネリック引数`IUser`主キーの種類を使用してクラスを派生できます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="0e48e-184">参照してください、 [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt)サンプル文字列から int または GUID に主キーを変更する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="0e48e-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="0e48e-185">ApplicationUser</span></span>

<span data-ttu-id="0e48e-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) で定義されている*Models\IdentityModels.cs*として。</span><span class="sxs-lookup"><span data-stu-id="0e48e-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="0e48e-187">上記の強調表示されたコードを生成、 [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="0e48e-188">ASP.NET Identity と OWIN クッキー認証は、クレーム ベース、したがって、framework が、アプリを生成する必要があります、`ClaimsIdentity`ユーザー。</span><span class="sxs-lookup"><span data-stu-id="0e48e-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="0e48e-189">`ClaimsIdentity` 情報を持つユーザーの名など、ユーザーのすべての要求についての時代し、ユーザーが所属するロール。</span><span class="sxs-lookup"><span data-stu-id="0e48e-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="0e48e-190">この段階でユーザーの複数のクレームを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="0e48e-191">OWIN`AuthenticationManager.SignIn`メソッドで、`ClaimsIdentity`とし、ユーザー サインインします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="0e48e-192">[Facebook、Twitter、LinkedIn、Google の OAuth2 サインオンした MVC 5 アプリケーション](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)する追加のプロパティを追加する方法を示しています、`ApplicationUser`クラス。</span><span class="sxs-lookup"><span data-stu-id="0e48e-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="0e48e-193">確認の電子メール</span><span class="sxs-lookup"><span data-stu-id="0e48e-193">Email confirmation</span></span>

<span data-ttu-id="0e48e-194">他のユーザーを偽装していないことを確認する新しいユーザーに登録メールを確認することをお勧め (つまりに登録していない他のユーザーの電子メールで)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="0e48e-195">ようにしたい、ディスカッション フォーラムが`"bob@example.com"`としての登録から`"joe@contoso.com"`します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="0e48e-196">電子メールの確認を求めず`"joe@contoso.com"`アプリから不要な電子メールを取得する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="0e48e-197">として誤って Bob が登録されていると仮定`"bib@example.com"`気付いていなかったとパスワードの回復を使用して、アプリは、正しいメール アドレスがある見つからないため、彼はできません。</span><span class="sxs-lookup"><span data-stu-id="0e48e-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="0e48e-198">確認の電子メールがボットから制限の保護のみを提供し、決定スパムから保護を提供しません、登録に使用できる多くの作業用電子メールの別名が。次の例では、ユーザーは自分のアカウントのことを確認するまで、自分のパスワードを変更することできません (それらによりに登録した電子メール アカウントで受信した確認リンクをクリックします)。この作業の流れは、例を確認し、これに自分のプロファイルを変更したときに、ユーザーに電子メールを送信、管理者によって作成された新しいアカウントのパスワードをリセット リンクを送信する他のシナリオに適用できます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="0e48e-199">新しいユーザーが電子メール、SMS テキスト メッセージまたは別のメカニズムによって確認されて前に、web サイトにデータを投稿するを防ぐために一般的にします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="0e48e-200">完全なサンプルのビルド</span><span class="sxs-lookup"><span data-stu-id="0e48e-200">Building a more complete sample</span></span>

<span data-ttu-id="0e48e-201">このセクションでは、皆様より完全なサンプルをダウンロードする NuGet を使用します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="0e48e-202">新規作成***空***ASP.NET Web プロジェクト。</span><span class="sxs-lookup"><span data-stu-id="0e48e-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="0e48e-203">パッケージ マネージャー コンソールで、次を入力します。 次のコマンド。</span><span class="sxs-lookup"><span data-stu-id="0e48e-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="0e48e-204">このチュートリアルで使用します[SendGrid](http://sendgrid.com/)電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="0e48e-205">`Identity.Samples`パッケージで使用されるコードをインストールします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="0e48e-206">設定、 [SSL を使用するプロジェクト](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="0e48e-207">クリックすると、アプリを実行してローカル アカウントの作成、テスト、**登録**リンク、および登録フォームを投稿します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="0e48e-208">確認の電子メールをシミュレートするデモ電子メール リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="0e48e-209">サンプルからデモ電子メール リンク確認コードを削除 (、 `ViewBag.Link` account コント ローラー コード。</span><span class="sxs-lookup"><span data-stu-id="0e48e-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="0e48e-210">参照してください、`DisplayEmail`と`ForgotPasswordConfirmation`アクション メソッドと razor ビュー)。</span><span class="sxs-lookup"><span data-stu-id="0e48e-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="0e48e-211">警告: このサンプルでは、セキュリティ設定のいずれかを変更すると、運用アプリが行われた変更を明示的に呼び出すのセキュリティ監査を受ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="0e48e-212">アプリでコードを調べる\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="0e48e-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="0e48e-213">アカウントを作成しに追加する方法を示します、*管理者*ロール。</span><span class="sxs-lookup"><span data-stu-id="0e48e-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="0e48e-214">サンプルの電子メールを管理者アカウントを使用する電子メールと置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="0e48e-215">管理者アカウントを作成するには、現在最も簡単な方法は、プログラム的に、`Seed`メソッド。</span><span class="sxs-lookup"><span data-stu-id="0e48e-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="0e48e-216">作成し、ユーザーとロールを管理することがツールを将来があることと思います。</span><span class="sxs-lookup"><span data-stu-id="0e48e-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="0e48e-217">サンプル コードには、ユーザーとロールを作成および管理することは、ロールとユーザー管理ページを実行する管理者アカウントがあります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="0e48e-218">このサンプルでは、DB のシード処理時に、管理者アカウントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="0e48e-219">パスワードを変更し、電子メール通知を受信できるアカウントに名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="0e48e-220">セキュリティ - ソース コード内の機密データは store ことはありません。</span><span class="sxs-lookup"><span data-stu-id="0e48e-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="0e48e-221">以前は、説明したように、 `app.CreatePerOwinContext` startup クラス内の呼び出しにコールバックを追加する、`Create`アプリ DB コンテンツ、ユーザー マネージャーと役割マネージャー クラスのメソッド。</span><span class="sxs-lookup"><span data-stu-id="0e48e-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="0e48e-222">OWIN パイプラインの呼び出し、`Create`これらのメソッドは要求ごとにクラスし、コンテキストの各クラスを格納します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="0e48e-223">アカウント コント ローラーには、HTTP コンテキスト (を OWIN コンテキストを含む) からユーザーのマネージャーが公開しています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="0e48e-224">ユーザーがローカルのアカウントを登録すると、`HTTP Post Register`メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="0e48e-225">上記のコードでは、モデル データを使用して電子メールとパスワードの入力を使用して、新しいユーザー アカウントを作成します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="0e48e-226">電子メール エイリアスが、データ ストア内にある場合は、アカウントの作成が失敗して、フォームが再び表示されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="0e48e-227">`GenerateEmailConfirmationTokenAsync`メソッドは、セキュリティで保護された確認トークンを作成し、ASP.NET Identity データ ストアに格納されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="0e48e-228">[Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)メソッドは、リンクを含む、作成、`UserId`および確認トークン。</span><span class="sxs-lookup"><span data-stu-id="0e48e-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="0e48e-229">このリンクは、ユーザーに電子メールで送信し、ユーザーが自分のアカウントを確認する電子メール アプリのリンクをクリックできます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="0e48e-230">確認の電子メール設定します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-230">Set up email confirmation</span></span>

<span data-ttu-id="0e48e-231">移動して、 [Azure SendGrid へのサインアップ ページ](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)無料アカウントで登録するとします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="0e48e-232">SendGrid を構成するために、次のようなコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="0e48e-233">電子メール クライアントには、頻繁にテキスト メッセージ (HTML なし) のみがそのまま使用します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="0e48e-234">テキストおよび HTML でメッセージを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="0e48e-235">上記の SendGrid サンプルでは、これは、`myMessage.Text`と`myMessage.Html`上記のコード。</span><span class="sxs-lookup"><span data-stu-id="0e48e-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="0e48e-236">次のコードは、電子メールを使用して送信する方法を示します、 [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)クラス`message.Body`リンクのみを返します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="0e48e-237">セキュリティ - ソース コード内の機密データは store ことはありません。</span><span class="sxs-lookup"><span data-stu-id="0e48e-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="0e48e-238">アカウントと資格情報は、appSetting で格納されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="0e48e-239">Azure では安全に保管するこれらの値で、 **[構成](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** Azure portal でのタブ。</span><span class="sxs-lookup"><span data-stu-id="0e48e-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="0e48e-240">参照してください[ASP.NET と Azure へパスワードやその他の機密データを展開するためのベスト プラクティス](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="0e48e-241">SendGrid の資格情報を入力して、アプリを実行するには、電子メール エイリアスを登録は、電子メールの確認リンクをクリックできます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="0e48e-242">これを行う方法について、 [Outlook.com](http://outlook.com)電子メール アカウント、John Atten を参照してください[Outlook.Com SMTP ホスト用の c# の SMTP 構成](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)彼と[ASP.NET Identity 2.0: アカウントの検証の設定2 要素認証と](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)投稿します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="0e48e-243">ユーザーがクリックされると、**登録**のメール アドレスの検証トークンを含む確認の電子メールが送信されるボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="0e48e-244">ユーザーは自分のアカウントの確認トークンを使用して電子メールで送信されます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="0e48e-245">コードを確認します</span><span class="sxs-lookup"><span data-stu-id="0e48e-245">Examine the code</span></span>

<span data-ttu-id="0e48e-246">次のコードは `POST ForgotPassword` メソッドを示します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="0e48e-247">ユーザーの電子メール アドレスが確認されていない場合、メソッドはサイレント モードで失敗します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="0e48e-248">エラーは、無効な電子メール アドレスにポストされた、悪意のあるユーザーは、攻撃するのに有効なユーザー Id (電子メールのエイリアス) を検索するのに情報を使用できます。</span><span class="sxs-lookup"><span data-stu-id="0e48e-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="0e48e-249">次のコードは、`ConfirmEmail`メソッドは、ユーザーが送信された電子メールの確認リンクをクリックしたときに呼び出される、account コント ローラー。</span><span class="sxs-lookup"><span data-stu-id="0e48e-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="0e48e-250">忘れたパスワード トークンが使用されるは無効になります。</span><span class="sxs-lookup"><span data-stu-id="0e48e-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="0e48e-251">次のコードの変更、`Create`メソッド (で、*アプリ\_Start\IdentityConfig.cs*ファイル) を 3 時間で期限切れのトークンを設定します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="0e48e-252">上記のコードでは、パスワードを忘れてしまったと、電子メール確認トークンは 3 時間で期限切れ。</span><span class="sxs-lookup"><span data-stu-id="0e48e-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="0e48e-253">既定の`TokenLifespan`1 日になっています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="0e48e-254">次のコードは、電子メールの確認方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="0e48e-255">アプリのセキュリティを強化するには、ASP.NET Identity では 2 要素認証 (2 fa) をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="0e48e-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="0e48e-256">参照してください[ASP.NET Identity 2.0: アカウントの検証と 2 要素認証を設定する](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)John Atten でします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="0e48e-257">ログイン パスワードの試行の失敗では、アカウントのロックアウトを設定できますが、そのアプローチにより、ログインを受けやすい[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)ロックアウトします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="0e48e-258">2 fa でのみアカウントのロックアウトを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="0e48e-259">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="0e48e-259">Additional Resources</span></span>

- [<span data-ttu-id="0e48e-260">ASP.NET Identity のカスタム ストレージ プロバイダーの概要</span><span class="sxs-lookup"><span data-stu-id="0e48e-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="0e48e-261">[Facebook、Twitter、LinkedIn、Google の OAuth2 サインオンした MVC 5 アプリケーション](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)プロファイル情報をユーザー テーブルに追加する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="0e48e-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="0e48e-262">[ASP.NET MVC と Id 2.0: 基本を理解する](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)John Atten でします。</span><span class="sxs-lookup"><span data-stu-id="0e48e-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="0e48e-263">ASP.NET Identity 入門</span><span class="sxs-lookup"><span data-stu-id="0e48e-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="0e48e-264">[ASP.NET Identity 2.0.0 の RTM の発表](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx)Pranav Rastogi が。</span><span class="sxs-lookup"><span data-stu-id="0e48e-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
