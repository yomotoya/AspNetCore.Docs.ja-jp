---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: Azure Active Directory と ASP.NET アプリの開発 |Microsoft Docs
author: Rick-Anderson
description: Azure Active Directory 用の Microsoft ASP.NET ツールにより、簡単に Azure でホストされている web アプリケーションの認証を有効にします。 Azure 認証を使用することができます.
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 96a6b8d1c258e742907b649b631f8a6c2c4bbf98
ms.sourcegitcommit: 7b4e3936feacb1a8fcea7802aab3e2ea9c8af5b4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/04/2018
ms.locfileid: "48577471"
---
<a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="5dae6-104">Azure Active Directory と ASP.NET アプリの開発</span><span class="sxs-lookup"><span data-stu-id="5dae6-104">Developing ASP.NET Apps with Azure Active Directory</span></span>
====================
<span data-ttu-id="5dae6-105">によって[Rick Anderson]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="5dae6-105">by [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

<span data-ttu-id="5dae6-106">Azure Active Directory でホストされる web アプリの認証を有効化を簡素化用のツールは Microsoft ASP.NET [Azure](https://www.windowsazure.com/home/features/web-sites/)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="5dae6-107">Azure 認証を使用して、組織、オンプレミスの Active Directory から同期された会社のアカウントまたはカスタムの Azure Active Directory ドメインで作成されたユーザーから Office 365 ユーザーを認証することができます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="5dae6-108">Windows Azure Authentication を有効にすると、1 つを使用してユーザーを認証するアプリケーションを構成します[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)テナント。</span><span class="sxs-lookup"><span data-stu-id="5dae6-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="5dae6-109">このチュートリアルがサインオン用に構成された ASP.NET アプリケーションを作成する方法を示します[Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD)。</span><span class="sxs-lookup"><span data-stu-id="5dae6-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="5dae6-110">アプリケーションを Azure にデプロイする方法と、現在サインインしているユーザーに関する情報を取得する Graph API を呼び出す方法も学習します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="5dae6-111">必須コンポーネント</span><span class="sxs-lookup"><span data-stu-id="5dae6-111">Prerequisites</span></span>

1. <span data-ttu-id="5dae6-112">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express)または[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-112">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express) or [Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads).</span></span>
2. <span data-ttu-id="5dae6-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) -Update 3 以降が必要です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="5dae6-114">Azure アカウント。</span><span class="sxs-lookup"><span data-stu-id="5dae6-114">An Azure account.</span></span> <span data-ttu-id="5dae6-115">[ここをクリックして](https://azure.microsoft.com/pricing/free-trial/)無料試用版アカウントを既に持っていない場合。</span><span class="sxs-lookup"><span data-stu-id="5dae6-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="5dae6-116">Active Directory にグローバル管理者を追加します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="5dae6-117">サインイン、 [Azure 管理ポータル](https://manage.windowsazure.com/)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="5dae6-118">すべての Azure アカウントを含む、**既定のディレクトリ**--[] をクリックし、をクリックして、**ユーザー**ページの上部にあるタブ (下図を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="5dae6-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="5dae6-119">ユーザーの追加 をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-119">Click Add User.</span></span>  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="5dae6-120">新しいユーザーを作成、**グローバル管理者**ロール。</span><span class="sxs-lookup"><span data-stu-id="5dae6-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="5dae6-121">をクリックして**ユーザー**から上部のメニューをクリック、**ユーザーの追加**コマンド バーのボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="5dae6-122">**ユーザーの追加**ダイアログ ボックスで、新しいユーザーの名前を入力し、右矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="5dae6-123">ユーザー名を入力し、ロールに設定**グローバル管理者**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="5dae6-124">グローバル管理者では、パスワードの回復のため、連絡用電子メール アドレスが必要です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="5dae6-125">完了したら、右矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-125">After you're finished, click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="5dae6-126">ダイアログ ボックスの次のページで次のようにクリックします。**作成**です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="5dae6-127">一時パスワードは、新しいユーザーの作成し、ダイアログに表示します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)  
  
   <span data-ttu-id="5dae6-128">パスワードを保存後、最初のログイン パスワードを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="5dae6-129">次の図は、新しい管理者アカウントを示します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-129">The following image shows the new admin account.</span></span> <span data-ttu-id="5dae6-130">Azure Active Directory を使用してもこのページに表示される Microsoft アカウントではなく、アプリにログインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="5dae6-131">ASP.NET アプリケーションを作成します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="5dae6-132">使用して、次の手順[Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747)、する必要があります[Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="5dae6-133">Visual Studio で、次のようにクリックします。**ファイル**し**新しいプロジェクト**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="5dae6-134">**新しいプロジェクト**ダイアログで、選択、Visual c# Web を左側のメニューからプロジェクト をクリックして**OK**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="5dae6-135">オフにすることも、**プロジェクトに Application Insights の追加**アプリケーション機能が必要ない場合。</span><span class="sxs-lookup"><span data-stu-id="5dae6-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="5dae6-136">**新しい ASP.NET プロジェクト**ダイアログ ボックスで、 **MVC**、 をクリックし、**認証の変更**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="5dae6-137">**認証の変更**ダイアログ ボックスで、**組織アカウント**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="5dae6-138">これらのオプションは、自動的に Azure AD と統合するアプリケーションを構成するほか、アプリケーションを Azure AD に自動的に登録を使用できます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="5dae6-139">使用する必要はありません、**認証の変更**登録し、これは、アプリケーションで構成するためのダイアログでは、はるかに簡単です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="5dae6-140">たとえば、Visual Studio 2012 を使用している場合、手動で、Azure 管理ポータルにアプリケーションを登録し、Azure AD と統合するには、その構成を更新します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>  
   <span data-ttu-id="5dae6-141">ドロップダウン メニューで、選択**クラウド - 単一の組織**と**シングル サインオン、ディレクトリ データの読み取り**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="5dae6-142">たとえば (下の画像) で、Azure AD ディレクトリのドメインを入力します。 *aricka0yahoo.onmicrosoft.com*、順にクリックします**OK**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="5dae6-143">Azure portal で、既定のディレクトリの [ドメイン] タブから、ドメイン名を取得できます (ダウンは、次のイメージを参照してください)。</span><span class="sxs-lookup"><span data-stu-id="5dae6-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)  
  
   <span data-ttu-id="5dae6-144">次の図には、Azure portal からドメイン名が表示されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-144">The following image shows the domain name from the Azure portal.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)  

    > [!NOTE]
    > <span data-ttu-id="5dae6-145">クリックして Azure AD に登録されるアプリケーション ID URI を構成することもできます。**オプションより**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="5dae6-146">アプリ ID URI は、アプリケーションは、Azure AD に登録され、Azure AD と通信するときに識別する、アプリケーションで使用される一意の識別子です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="5dae6-147">アプリ ID URI と登録済みのアプリケーションの他のプロパティの詳細については、次を参照してください。[このトピックの「](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="5dae6-148">アプリ ID URI フィールドの下のチェック ボックスをクリックすると、同じアプリ ID URI を使用して Azure AD で既存の登録を上書きすることもできます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="5dae6-149">クリックすると**OK**サインイン ダイアログが表示され、グローバル管理者アカウント (Microsoft アカウントではなく、サブスクリプションに関連付けられている) を使用してサインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="5dae6-150">新しい管理者アカウントを先ほど作成した場合は、パスワードを変更し、もう一度新しいパスワードを使用してサインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="5dae6-151">正常に認証した後、**新しい ASP.NET プロジェクト**ダイアログに、認証の選択肢を表示 (**組織**) し、新しいアプリケーションがされるディレクトリの登録 (*aricka0yahoo.onmicrosoft.com*下図)。</span><span class="sxs-lookup"><span data-stu-id="5dae6-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="5dae6-152">この情報は、以下の選択 チェック ボックス**クラウドでホスト**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="5dae6-153">このチェック ボックスが選択されている場合、プロジェクトが Azure web アプリとしてプロビジョニングされ、後で簡単に公開するために有効になります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="5dae6-154">**[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-154">Click **OK**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="5dae6-155">**Azure web サイトの構成**サイトの自動生成された名前とリージョンを使用して、ダイアログが表示されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="5dae6-156">ダイアログ ボックスに現在サインイン アカウントにも注意してください。</span><span class="sxs-lookup"><span data-stu-id="5dae6-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="5dae6-157">このアカウントが、Azure サブスクリプションが関連付けられているものであるかどうかを確認する Microsoft アカウントでは通常します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="5dae6-158">このプロジェクトには、データベースが必要です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-158">This project requires a database.</span></span> <span data-ttu-id="5dae6-159">既存のデータベースのいずれかを選択するか、新しいものを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="5dae6-160">データベースは、プロジェクトは既に少量の認証の構成データを格納するローカル データベース ファイルを使用するために必要です。</span><span class="sxs-lookup"><span data-stu-id="5dae6-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="5dae6-161">Azure の web サイトにアプリケーションを展開するときにクラウドにアクセスできるいずれかを選択する必要があるためにもデプロイでこのデータベースがパッケージ化はありません。</span><span class="sxs-lookup"><span data-stu-id="5dae6-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="5dae6-162">**[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="5dae6-163">プロジェクトが作成され、認証オプションと web アプリのオプションをプロジェクトに自動的に構成されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="5dae6-164">このプロセスが完了すると、ローカルでキーを押してプロジェクトを実行 **^ F5**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="5dae6-165">お客様の組織アカウントを使用してサインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="5dae6-166">先ほど作成したアカウントのユーザー名とパスワードを入力し、クリックして**サインイン**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="5dae6-167">正常にサインインした後、ページの右上隅で、ユーザー名を表示することで認証されましたが、ASP.NET サイトが表示されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)  
  
   <span data-ttu-id="5dae6-168">エラーが発生した場合は、次のようにします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-168">If you get the error:</span></span>  
   <span data-ttu-id="5dae6-169">値は、null または空にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="5dae6-169">Value cannot be null or empty.</span></span> <span data-ttu-id="5dae6-170">パラメーター名: linkText</span><span class="sxs-lookup"><span data-stu-id="5dae6-170">Parameter name: linkText</span></span>   
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)  
  
   <span data-ttu-id="5dae6-171">参照してください、[デバッグ](#dbg)チュートリアルの最後のセクション。</span><span class="sxs-lookup"><span data-stu-id="5dae6-171">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="5dae6-172">Graph API の基本</span><span class="sxs-lookup"><span data-stu-id="5dae6-172">Basics of the Graph API</span></span>

<span data-ttu-id="5dae6-173">[Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx)は、Azure AD ディレクトリの CRUD とオブジェクトの他の操作を実行するために使用するプログラム インターフェイスです。</span><span class="sxs-lookup"><span data-stu-id="5dae6-173">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="5dae6-174">Visual Studio 2013 で新しいプロジェクトを作成するときに認証するための組織のアカウントのオプションを選択した場合、アプリケーションは Graph API を呼び出す構成既に。</span><span class="sxs-lookup"><span data-stu-id="5dae6-174">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="5dae6-175">このセクションについて簡単にでは、Graph API のしくみです。</span><span class="sxs-lookup"><span data-stu-id="5dae6-175">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="5dae6-176">上部にあるサインイン ユーザーの名前をクリックして、実行中のアプリケーションで、ページの右。</span><span class="sxs-lookup"><span data-stu-id="5dae6-176">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="5dae6-177">これで、ホーム コント ローラーのアクションであるユーザー プロファイル ページに移動されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-177">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="5dae6-178">先ほど作成した管理者アカウントのユーザー情報が、テーブルに含まれていることがわかります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-178">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="5dae6-179">ディレクトリに、この情報を格納し、Graph API が呼び出され、ページが読み込まれるときに、この情報を取得します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-179">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="5dae6-180">Visual Studio に戻り、展開、**コント ローラー**フォルダーと順に開いて、 **HomeController.cs**ファイル。</span><span class="sxs-lookup"><span data-stu-id="5dae6-180">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="5dae6-181">表示されます、 **UserProfile()** トークンを取得し、Graph API を呼び出すコードが含まれるアクション。</span><span class="sxs-lookup"><span data-stu-id="5dae6-181">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="5dae6-182">このコードは、以下が重複しています。</span><span class="sxs-lookup"><span data-stu-id="5dae6-182">This code is duplicated below:</span></span> 

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="5dae6-183">Graph API を呼び出すには、まず、トークンを取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-183">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="5dae6-184">トークンが取得されたときに、Graph API へのすべての後続の要求の Authorization ヘッダー内の文字列値を追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-184">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="5dae6-185">上記のコードの大部分は、トークンを取得する Azure AD への認証、トークンを使用して、Graph api 呼び出しを実行して、ビューで表現できるように、応答を変換の詳細を処理します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-185">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="5dae6-186">最も重要な部分については、次の強調表示された行:`UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-186">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="5dae6-187">この行は、JSON 応答から逆シリアル化されたがあり、ビューに表示されますが、ユーザーの名前を表します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-187">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="5dae6-188">簡単な方法は、使用する HttpClient を使用して Graph API を呼び出すし、自分で生データを処理することができますが、 [Graph クライアント ライブラリは NuGet から入手可能](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-188">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="5dae6-189">クライアント ライブラリでは、未加工の HTTP 要求と、返されたデータの変換を処理し、.NET 環境での Graph API を使用するはるかに簡単になります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-189">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="5dae6-190">関連の Graph API コード サンプルを参照してください[GitHub します。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="5dae6-190">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="5dae6-191">アプリケーションを Azure にデプロイします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-191">Deploy the Application to Azure</span></span>

<span data-ttu-id="5dae6-192">次の手順では、Azure にアプリケーションをデプロイする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-192">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="5dae6-193">前の手順で接続して、新しいプロジェクトを Azure に web アプリでできるようになりますが、いくつかの手順で発行する準備が。</span><span class="sxs-lookup"><span data-stu-id="5dae6-193">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="5dae6-194">Visual Studio でクリックし、プロジェクトを右クリックして**発行**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-194">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="5dae6-195">**Web の発行**既に構成されている各設定にダイアログが表示されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-195">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="5dae6-196">をクリックして、**次**へ移動するボタン、**設定**ページ。</span><span class="sxs-lookup"><span data-stu-id="5dae6-196">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="5dae6-197">認証を求められますAzure サブスクリプション アカウント (通常は Microsoft アカウント) と前に作成した組織アカウントではなくを使用して認証することを確認します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-197">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="5dae6-198">チェック、**組織認証を有効にする**オプション。</span><span class="sxs-lookup"><span data-stu-id="5dae6-198">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="5dae6-199">**ドメイン**フィールドに、ディレクトリのドメインを入力します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-199">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="5dae6-200">**アクセス レベル**ドロップダウン リストで選択**シングル サインオン、ディレクトリ データの読み取り**します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-200">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="5dae6-201">使用した以前のデータベースが既に設定されているかがわかります、**データベース**セクション。</span><span class="sxs-lookup"><span data-stu-id="5dae6-201">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="5dae6-202">**[発行]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-202">Click **Publish**.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="5dae6-203">Visual Studio により、web サイトのデプロイが開始し、新しいブラウザー ウィンドウが表示されます。</span><span class="sxs-lookup"><span data-stu-id="5dae6-203">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="5dae6-204">ここでも、ディレクトリに対する認証を求めるメッセージが表示可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5dae6-204">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="5dae6-205">次の情報を認証したら、Azure で新たに発行された web サイトにリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-205">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="5dae6-206">アプリのデバッグ</span><span class="sxs-lookup"><span data-stu-id="5dae6-206">Debugging the app</span></span>

<span data-ttu-id="5dae6-207">: 次のエラーが発生した場合</span><span class="sxs-lookup"><span data-stu-id="5dae6-207">If you get the following error:</span></span>   
 <span data-ttu-id="5dae6-208">値は、null または空にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="5dae6-208">Value cannot be null or empty.</span></span> <span data-ttu-id="5dae6-209">パラメーター名: linkText</span><span class="sxs-lookup"><span data-stu-id="5dae6-209">Parameter name: linkText</span></span>   
   
![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)  
  

<span data-ttu-id="5dae6-210">コードに置き換えます、 *views \shared\\_LoginPartial.cshtml*を次のファイル。</span><span class="sxs-lookup"><span data-stu-id="5dae6-210">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="5dae6-211">ログインしているユーザーには、「Null ユーザー」が表示される場合、アプリを実行した後、サインアウトして先ほど作成した Active Directory アカウントを使用して再度サインインします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-211">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="5dae6-212">従うの優れたチュートリアルが Rick Rainey の[Deep Dive: Azure Websites および Azure AD を使用して組織の認証](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)します。</span><span class="sxs-lookup"><span data-stu-id="5dae6-212">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="5dae6-213">説明</span><span class="sxs-lookup"><span data-stu-id="5dae6-213">More Information</span></span>

- [<span data-ttu-id="5dae6-214">Deep Dive: Azure Websites と Azure AD を使用して組織の認証</span><span class="sxs-lookup"><span data-stu-id="5dae6-214">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="5dae6-215">Azure AD Graph API の概要</span><span class="sxs-lookup"><span data-stu-id="5dae6-215">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="5dae6-216">Azure AD での認証シナリオ</span><span class="sxs-lookup"><span data-stu-id="5dae6-216">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="5dae6-217">GitHub での azure AD コード サンプルします。</span><span class="sxs-lookup"><span data-stu-id="5dae6-217">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
