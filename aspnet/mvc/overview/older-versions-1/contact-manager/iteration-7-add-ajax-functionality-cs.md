---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
title: '繰り返し #7 – Ajax 機能を追加 (c#) |Microsoft Docs'
author: microsoft
description: 7 番目のイテレーションで改良、応答性と、アプリケーションのパフォーマンスの Ajax のサポートを追加します。
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f1b0809e-8909-444e-b6bb-a5cd1dea3f72
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
msc.type: authoredcontent
ms.openlocfilehash: a51713e57872ccfc3a76cf91fec728fdb6fa1eac
ms.sourcegitcommit: 45ac74e400f9f2b7dbded66297730f6f14a4eb25
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/16/2018
ms.locfileid: "41838014"
---
<a name="iteration-7--add-ajax-functionality-c"></a>繰り返し #7 – Ajax 機能を追加 (c#)
====================
によって[Microsoft](https://github.com/microsoft)

[コードをダウンロードします。](iteration-7-add-ajax-functionality-cs/_static/contactmanager_7_cs1.zip)

> 7 番目のイテレーションで改良、応答性と、アプリケーションのパフォーマンスの Ajax のサポートを追加します。


## <a name="building-a-contact-management-aspnet-mvc-application-c"></a>連絡先管理 ASP.NET MVC アプリケーション (c#) の構築

このチュートリアル シリーズでは、開始から終了に全体連絡先管理アプリケーションを構築します。 Contact Manager アプリケーションは、ユーザーの一覧については店舗連絡先情報の名前、電話番号、電子メール アドレスにするようにことができます。

複数のイテレーションにおける、アプリケーションを構築します。 反復処理ごとに、アプリケーション徐々 に向上します。 この複数のイテレーションのアプローチの目的は、各変更の理由を理解するためです。

- 繰り返し #1 - は、アプリケーションを作成します。 最初のイテレーションを作成、連絡先マネージャー最も簡単な方法で考えられるします。 基本的なデータベース操作のサポートを追加します: 作成、読み取り、更新、および削除 (CRUD)。

- 繰り返し #2 - は、素敵に見えるアプリケーションを作成します。 このイテレーションで、アプリケーションの見た目を向上させる、既定の ASP.NET MVC ビュー マスター ページを変更し、カスケード スタイル シート。

- 繰り返し #3 - フォーム検証を追加します。 3 番目のイテレーションでは、基本的なフォーム検証を追加します。 ユーザーは、必要なフォームのフィールドを完了しなくても、フォームを送信できないようにようにします。 また、電子メール アドレスと電話番号を検証しました。

- 繰り返し #4 - は、アプリケーションを疎結合を作成します。 この 4 番目のイテレーションで、保守し、Contact Manager アプリケーションの変更を容易にできるようにするソフトウェア設計パターンをいくつかの利点を実行します。 たとえば、Repository パターンと依存関係の注入パターンを使用するようにアプリケーションをリファクタリングします。

- 繰り返し #5 - 単体テストを作成します。 5 番目のイテレーションでアプリケーションと簡単に維持単体テストを追加して変更します。 データ モデル クラスの模擬テストを実行し、コント ローラーと検証ロジックの単体テストをビルドします。

- 繰り返し #6 - は、テスト駆動開発を使用します。 この 6 番目のイテレーションでは、アプリケーションに新しい機能を追加には、まず単体テストの記述、単体テストに対してコードを記述します。 このイテレーションは、連絡先グループを追加します。

- 繰り返し #7 - Ajax 機能を追加します。 7 番目のイテレーションで改良、応答性と、アプリケーションのパフォーマンスの Ajax のサポートを追加します。

## <a name="this-iteration"></a>このイテレーション

このイテレーションの Contact Manager アプリケーションは、Ajax を使用するようにアプリケーションをリファクタリングします。 Ajax を利用してアプリケーションを作成する、応答性が向上します。 ページの特定の領域のみを更新する必要があるときのページ全体を表示回避できます。

ユーザーが新しい連絡先グループを選択するたびに、ページ全体を再表示する必要があるように、インデックス ビューをリファクタリングします。 代わりに、連絡先グループをクリックしたときがだけ連絡先の一覧が更新され、ページの残りの部分をそのまま。

弊社削除動作をリンクする方法も変更します。 別の確認ページを表示するには、代わりに JavaScript の確認ダイアログ表示します。 連絡先を削除することを確認する場合、HTTP DELETE 操作は、データベースからの連絡先レコードを削除するサーバーに対して実行します。

さらに、活用 jQuery アニメーション効果をインデックス ビューに追加することになります。 新しい連絡先の一覧がサーバーからフェッチされるときにアニメーションが表示されます。

最後に、ブラウザーの履歴を管理するための ASP.NET AJAX フレームワークのサポートを活用をみましょう。 連絡先の一覧を更新する Ajax 呼び出しを実行するたびに、履歴ポイントを作成します。 これにより、下位互換性および上位のブラウザーのボタンは機能します。

## <a name="why-use-ajax"></a>Ajax を使用する理由

Ajax には、多くのメリットがあります。 最初に、優れたユーザー エクスペリエンスで、アプリケーションの結果に Ajax 機能を追加します。 通常の web アプリケーションでページ全体する必要があります投稿サーバーに、毎回のユーザーがアクションを実行します。 アクションを実行するたびに、ブラウザーをロックし、ユーザー待つ必要がありますページ全体がフェッチされ、再表示されます。

デスクトップ アプリケーションの場合、許容できないエクスペリエンスになります。 ただし、これまでは、私たちない有効期間の web アプリケーションの場合は、この無効なユーザー エクスペリエンスをそれ以上行われる可能性がありますが認識がないためです。 Imaginations の制限だけが実際には、ときに、web アプリケーションの制限をだと考えました。

Ajax アプリケーションでページを更新するだけの停止をユーザー エクスペリエンスを実現する必要はありません。 代わりに、ページを更新するバック グラウンドで非同期の要求を実行できます。 ページの一部が更新されるまで待つユーザー t の強制はありません。

Ajax を利用してもに、アプリケーションのパフォーマンスを向上できます。 Ajax の機能がない Contact Manager アプリケーションの今すぐ動作を検討してください。 連絡先グループをクリックすると、全体のインデックス ビューを再表示する必要があります。 連絡先グループの一覧と連絡先の一覧は、データベース サーバーから取得する必要があります。 このデータをすべて渡す必要があります、ネットワーク経由で web サーバーからの web ブラウザーにします。

後、アプリケーションに Ajax 機能を追加すると、ただし、使えるように連絡先グループをクリックすると、ページ全体を再表示します。 データベースから連絡先グループを取得する必要がなくなりました。 ネットワーク経由で全体のインデックス ビューをプッシュする必要もありません。 Ajax を利用して、データベース サーバーを実行する必要がある作業量を削減し、アプリケーションで必要なネットワーク トラフィックの量を削減します。

## <a name="don-t-be-afraid-of-ajax"></a>ないことを恐れての Ajax をします。

一部の開発者では、下位レベルのブラウザーについて心配する必要があるために、Ajax を使用しないでください。 JavaScript をサポートしていないブラウザーでアクセスするときに、自分の web アプリケーションがまだ動作するようにします。 Ajax は、JavaScript に依存しているため、一部の開発者は、Ajax を使用しないでください。

ただし、Ajax を実装する方法については注意する場合は、上位レベルと下位レベルの両方のブラウザーで動作するアプリケーションを構築できます。 JavaScript をサポートするブラウザーおよびブラウザーでない、Contact Manager アプリケーションは動作します。

JavaScript をサポートするブラウザーで Contact Manager アプリケーションを使用する場合は、優れたユーザー エクスペリエンスがあります。 たとえば、連絡先グループをクリックすると、連絡先を表示するページのリージョンのみが更新されます。

一方で、JavaScript をサポートしていない (または JavaScript が無効ですが)、ブラウザーで Contact Manager アプリケーションを使用する場合は、少し望ましいユーザー エクスペリエンスがあります。 たとえば、連絡先グループをクリックすると全体のインデックス ビューする必要があります投稿、ブラウザーに一致する連絡先の一覧を表示するためにします。

## <a name="adding-the-required-javascript-files"></a>必要な JavaScript ファイルを追加します。

私たちは、3 つの JavaScript ファイルを使用して、アプリケーションに Ajax 機能を追加する必要があります。 新しい ASP.NET MVC アプリケーションの Scripts フォルダーには、これらのファイルの 3 つすべてが含まれます。

アプリケーションで複数のページで Ajax を使用する場合、理にかなってアプリケーションのビュー マスター ページで、必要な JavaScript ファイルが含まれます。 そうすること JavaScript ファイルするすべてのアプリケーションのページで自動的に含められます。

追加の内部で次の JavaScript が含まれています、&lt;ヘッド&gt;ビュー マスター ページのタグ。

[!code-html[Main](iteration-7-add-ajax-functionality-cs/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Ajax を使用するインデックス ビューのリファクタリング

S の連絡先を表示するビューの領域を更新のみ連絡先グループ をクリックするように、インデックス ビューを変更することで開始できるようにします。 図 1 で赤いボックスには、リージョン更新することにはが含まれています。


[![連絡先のみを更新しています](iteration-7-add-ajax-functionality-cs/_static/image1.jpg)](iteration-7-add-ajax-functionality-cs/_static/image1.png)

**図 01**: 連絡先のみを更新 ([フルサイズの画像を表示する をクリックします](iteration-7-add-ajax-functionality-cs/_static/image2.png))。


最初の手順は、別の部分 (ビュー ユーザー コントロール) に非同期的に更新するビューの一部を分離します。 連絡先のテーブルを表示する Index ビューのセクションでは、リスト 1 で部分に移動されました。

**1 - Views\Contact\ContactList.ascx を一覧表示します。**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample2.aspx)]

リスト 1 で部分が別のモデル ビューのインデックスであることを確認します。 *Inherits*属性、&lt;ページ % @ %&gt;ディレクティブの指定部分は、ViewUserControl 継承&lt;グループ&gt;クラス。

更新されたインデックス ビューは、リスト 2 に含まれています。

**2 - Views\Contact\Index.aspx を一覧表示します。**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample3.aspx)]

リスト 2 で更新されたビューに関する注意すべき 2 つの点があります。 最初に、すべての部分に移動したコンテンツを Html.RenderPartial() への呼び出しに置き換えることに注意してください。 連絡先の初期セットを表示するために、インデックス ビューが最初に要求された Html.RenderPartial() メソッドが呼び出されます。

次に、連絡先グループを表示するために使用する Html.ActionLink() が、Ajax.ActionLink() で置き換えられることに注意してください。 Ajax.ActionLink() は、次のパラメーターで呼び出されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample4.aspx)]

最初のパラメーターのリンクに表示するテキストを表すし、2 番目のパラメーターは、ルート値を表す 3 番目のパラメーターは、Ajax オプションを表します。 この場合は、UpdateTargetId Ajax オプション、HTML を指す使用&lt;div&gt; Ajax 要求が完了した後に更新するタグ。 更新する、 &lt;div&gt;新しい連絡先の一覧を持つタグ。

連絡先のコント ローラーの更新された Index() メソッドは、リスト 3 に含まれます。

**3 - Controllers\ContactController.cs (Index メソッド) を一覧表示します。**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample5.cs)]

更新された Index() アクションでは、次の 2 つのいずれかの条件付きで返します。 Index() アクションは、Ajax 要求によって呼び出される場合、コント ローラーは、部分を返します。 それ以外の場合、Index() アクションはビュー全体を返します。

Index() アクションが、Ajax 要求によって呼び出されたときに多くのデータを返す必要がないことに注意してください。 通常の要求のコンテキストでは、Index アクションは、すべての連絡先のグループと、選択した連絡先グループの一覧を返します。 Ajax 要求のコンテキストでは、Index() アクションは、選択したグループのみを返します。 Ajax では、データベース サーバーの処理量が少ないを意味します。

上位と下位レベルの両方のブラウザーの場合、変更したのインデックス ビューには機能します。 連絡先のグループをクリックすると、お使いのブラウザーが JavaScript をサポートしている、連絡先の一覧を含むビューの領域だけが更新されます。 その一方で、お使いのブラウザーは JavaScript をサポートしていない場合は、ビュー全体が更新されます。


この更新されたインデックス ビューには、1 つの問題があります。 連絡先グループをクリックすると、選択したグループが強調表示されません。 グループの一覧表示されるので、Ajax 要求中に更新されるリージョンの外で、適切なグループが強調表示されませんが。 次のセクションでこの問題を修正します。


## <a name="adding-jquery-animation-effects"></a>JQuery アニメーション効果を追加します。

通常、web ページのリンクをクリックすると、ブラウザーが、更新されたコンテンツをフェッチしてアクティブにするかどうかを検出するために、ブラウザーの進行状況バーを使用できます。 Ajax 要求を実行するときにその一方で、ブラウザーの進行状況バーには、進行状況項目表示されません。 ユーザーが不安に行うことができます。 ブラウザーが固定されているかどうかを知る方法

作業が Ajax 要求の実行中に実行されることをユーザーに示すことのできるいくつかの方法はあります。 1 つの方法では、単純なアニメーションを表示します。 たとえば、Ajax 要求が開始され、要求が完了したときに、リージョンをフェードイン、領域をフェードアウトできます。

アニメーションの効果を作成する、Microsoft ASP.NET MVC framework に含まれています、jQuery ライブラリを使用します。 更新されたインデックス ビューは、リスト 4 に含まれています。

**4 - Views\Contact\Index.aspx を一覧表示します。**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample6.aspx)]

更新されたインデックス ビューに 3 つの新しい JavaScript 関数が含まれていることを確認します。 最初の 2 つの関数では、jQuery を使用して、フェードアウトし、新しい連絡先グループをクリックすると、連絡先の一覧で、フェードインします。 3 番目の関数では、エラー (たとえば、ネットワーク タイムアウト) で、Ajax 要求の結果とエラー メッセージが表示されます。

また、最初の関数は、選択したグループを強調表示の処理されます。 クラス = クリックされた要素の親要素 (LI 要素) を選択した属性が追加されます。 ここでも、jQuery 簡単に適切な要素を選択し、CSS クラスを追加します。

これらのスクリプトは Ajax.ActionLink() AjaxOptions パラメーターのヘルプを持つグループのリンクに関連付けられています。 更新された Ajax.ActionLink() メソッドの呼び出しのようになります。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>ブラウザーの履歴のサポートを追加します。

通常、ページの更新へのリンクをクリックすると、ブラウザーの履歴が更新されます。 これにより、ページの以前の状態に移動するブラウザーの戻る ボタンをクリックすることができます。 たとえば、友人の連絡先グループをクリックして、ビジネスの連絡先グループ をクリックして場合、は、友人の連絡先グループを選択したときに、ページの状態に戻るにブラウザーの戻る ボタンをクリックします。

残念ながら、Ajax 要求の実行はブラウザーの履歴自動的に更新されません。 連絡先のグループをクリックすると、Ajax 要求に該当する連絡先の一覧を取得、ブラウザーの履歴は更新されません。 ブラウザーの [戻る] ボタンを使用して、新しい連絡先グループを選択した後、連絡先グループに移動することはできません。

Ajax 要求を実行する後ユーザーが戻る、ブラウザーを使用できるボタンを検索する場合は、もう少し作業を実行する必要があります。 ASP.NET AJAX フレームワークで構築されたブラウザーの履歴の管理機能を活用する必要があります。

ASP.NET AJAX ブラウザーの履歴、3 つの作業を行う必要があります。

1. EnableBrowserHistory プロパティを true に設定して、ブラウザーの履歴を有効にします。
2. AddHistoryPoint() メソッドを呼び出すことによって、ビューの状態が変更されたときに、履歴ポイントを保存します。
3. Navigate イベントが発生したときに、ビューの状態を再構築します。

更新されたインデックス ビューは、リスト 5 に含まれています。

**5 - Views\Contact\Index.aspx を一覧表示します。**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample8.aspx)]

リスト 5 では、ブラウザーの履歴は pageInit() 関数で有効にします。 PageInit() 関数は、navigate イベントのイベント ハンドラーを設定するのにも使用されます。 ブラウザー進むまたは戻る ボタンを変更するページの状態を発生するたびに、navigate イベントが発生します。

連絡先グループをクリックすると、beginContactList() メソッドが呼び出されます。 このメソッドは、addHistoryPoint() メソッドを呼び出すことによって、新しい履歴ポイントを作成します。 クリックされた連絡先グループの id は、履歴に追加されます。

グループ id は、連絡先グループ リンクを expando 属性から取得されます。 Ajax.ActionLink() に対する次の呼び出しでは、リンクが描画されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample9.aspx)]

最後に、Ajax.ActionLink() に渡されるパラメーターは、(XHTML の互換性のための小文字) のリンクを groupid をという名前の expando 属性を追加します。

ユーザーに達すると、ブラウザーの [戻るまたは進む] ボタン、navigate イベントが発生したし、navigate() メソッドが呼び出されます。 このメソッドは、navigate メソッドに渡されるブラウザー履歴ポイントに対応するページの状態と一致するページに表示される連絡先を更新します。

## <a name="performing-ajax-deletes"></a>Ajax を実行する削除されます。

現時点では、連絡先を削除する必要があります、削除 リンクをクリックし、削除の確認 ページに表示される 削除 ボタンをクリックする (図 2 参照)。 これは、多くのページ要求でデータベースのレコードを削除するような簡単な処理を行うように見えます。


[![削除の確認ページ](iteration-7-add-ajax-functionality-cs/_static/image2.jpg)](iteration-7-add-ajax-functionality-cs/_static/image3.png)

**図 02**: 削除の確認 ページ ([フルサイズの画像を表示する をクリックします](iteration-7-add-ajax-functionality-cs/_static/image4.png))。


削除の確認ページをスキップし、インデックス ビューから直接連絡先を削除することも考えになります。 このアプローチを採用するセキュリティ ホール、アプリケーションを開かれるために、この衝動を避ける必要があります。 一般がないは、web アプリケーションの状態を変更する操作を呼び出すときに HTTP GET 操作を実行します。 削除を実行するときに、HTTP POST を実行する、さらには、HTTP DELETE 操作したりします。

ContactList 部分で、[削除] リンクが含まれています。 ContactList 部分の更新バージョンを一覧表示する 6 含まれています。

**6 - Views\Contact\ContactList.ascx を一覧表示します。**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample10.aspx)]

Ajax.ImageActionLink() メソッドに次の呼び出しでは、[削除] リンクがレンダリングされます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample11.aspx)]

> [!NOTE] 
> 
> ASP.NET MVC フレームワークの標準の一部でない、Ajax.ImageActionLink() します。 Ajax.ImageActionLink() は、連絡先マネージャー プロジェクトに含まれるカスタム ヘルパー メソッドです。


AjaxOptions パラメーターには、2 つのプロパティがあります。 最初に、確認プロパティは、ポップアップの JavaScript の確認ダイアログの表示に使用されます。 次に、HttpMethod プロパティは、HTTP DELETE 操作の実行に使用されます。

7 を一覧表示するには、連絡先のコント ローラーに追加されている新しい AjaxDelete() アクションが含まれます。

**7 - Controllers\ContactController.cs (AjaxDelete) を一覧表示します。**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample12.cs)]

AjaxDelete() アクションは、AcceptVerbs 属性で装飾します。 この属性は、HTTP DELETE 操作以外の HTTP 操作によって以外で呼び出されているアクションをしないようにします。 具体的には、HTTP GET では、この操作を呼び出すことはできません。

データベース レコードを削除した後は、削除されたレコードが含まれていない連絡先の更新の一覧を表示する必要があります。 AjaxDelete() メソッドは、ContactList 部分と更新された連絡先の一覧を返します。

## <a name="summary"></a>まとめ

このイテレーションでは、Contact Manager アプリケーションに Ajax 機能を追加しました。 Ajax を使用して、応答性と、アプリケーションのパフォーマンスが向上しました。

まず、連絡先グループ をクリックしても、全体のビューが更新されないように、インデックス ビューにリファクタリングします。 代わりに、連絡先グループ をクリックすると、連絡先の一覧のみ更新します。

次に、jQuery アニメーション効果を使用して連絡先の一覧で、フェードインをフェードアウトします。 等価のブラウザーの進行状況バーに、アプリケーションのユーザーに提供する Ajax アプリケーションにアニメーションを追加を使用できます。

Ajax アプリケーションにも履歴のブラウザー サポートを追加しました。 ブラウザーの [戻る] をクリックし、Index ビューの状態を変更するボタンを転送するユーザーを有効にしました。

最後に、HTTP DELETE 操作をサポートする [削除] リンクを作成します。 Ajax の削除を実行する追加の削除の確認 ページを要求するユーザーを必要とせず、データベース レコードを削除するユーザーが有効にします。

> [!div class="step-by-step"]
> [前へ](iteration-6-use-test-driven-development-cs.md)
> [次へ](iteration-1-create-the-application-vb.md)
