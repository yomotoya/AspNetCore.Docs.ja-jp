---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: ロックを解除して、ユーザー アカウント (c#) を承認する |Microsoft Docs
author: rick-anderson
description: このチュートリアルは、管理者が管理する web ページを構築する方法を示しています。 ユーザーのロックアウトと状態を承認します。 新しいユーザーの o を承認する方法も表示されます.
ms.author: aspnetcontent
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: ab6fa1b460de671559dc16ca85f2a4df1e3d5922
ms.sourcegitcommit: b28cd0313af316c051c2ff8549865bff67f2fbb4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/05/2018
ms.locfileid: "37818305"
---
<a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="dedc2-104">ユーザー アカウントのロックを解除し、承認する (c#)</span><span class="sxs-lookup"><span data-stu-id="dedc2-104">Unlocking and Approving User Accounts (C#)</span></span>
====================
<span data-ttu-id="dedc2-105">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="dedc2-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="dedc2-106">[コードのダウンロード](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip)または[PDF のダウンロード](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="dedc2-106">[Download Code](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="dedc2-107">このチュートリアルは、管理者が管理する web ページを構築する方法を示しています。 ユーザーのロックアウトと状態を承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="dedc2-108">また、電子メール アドレスを確認、後にのみ、新しいユーザーを承認する方法もわかります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-108">We will also see how to approve new users only after they have verified their email address.</span></span>


## <a name="introduction"></a><span data-ttu-id="dedc2-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="dedc2-109">Introduction</span></span>

<span data-ttu-id="dedc2-110">各ユーザー アカウントが、ユーザーがサイトにログインできるかどうかを指定する 2 つの状態フィールドを持つユーザー名、パスワード、および電子メールと共に: ロックされており、承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="dedc2-111">自動的に、分 (既定の設定は、10 分以内に無効なログイン試行が 5 の後にユーザーをロック) の指定した数値の中で指定された回数無効な資格情報を提供する場合に、ユーザーのロックアウトが作成します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="dedc2-112">承認済みの状態は、新しいユーザーが、サイトにログオンする前に何らかのアクションが発生する必要があります、シナリオに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="dedc2-113">たとえば、ユーザーは、まず、電子メール アドレスを確認します。 または、ログインする前に、管理者が承認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="dedc2-114">ロックされた out または承認されていないユーザーがログインすることはできません、唯一の自然にこれらの状態をリセットする方法でしょうか。</span><span class="sxs-lookup"><span data-stu-id="dedc2-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="dedc2-115">ユーザーを管理するための Web コントロールがロックされており、これらの決定は、サイトごとに処理する必要があるために、一部の状態を承認または ASP.NET での組み込み機能が含まれません。</span><span class="sxs-lookup"><span data-stu-id="dedc2-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="dedc2-116">一部のサイトでは、すべての新しいユーザー アカウント (既定の動作) を自動的に承認があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="dedc2-117">管理者がある他のユーザーのサインアップ時に提供された電子メール アドレスに送信リンクにアクセスするまでユーザーを承認するか、新しいアカウントを承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="dedc2-118">同様に、管理者がその状態をリセットするまで、一部のサイトがユーザーをロックアウト可能性があります、そのアカウントのロック解除にアクセスできる他のサイトでは、URL を使用して、ロックアウトされたユーザーに電子メールを送信中にします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="dedc2-119">このチュートリアルは、管理者が管理する web ページを構築する方法を示しています。 ユーザーのロックアウトと状態を承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="dedc2-120">また、電子メール アドレスを確認、後にのみ、新しいユーザーを承認する方法もわかります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="dedc2-121">手順 1: 管理ユーザーのロックアウトし、承認の状態</span><span class="sxs-lookup"><span data-stu-id="dedc2-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="dedc2-122"><a id="Tutorial12"> </a> [*インターフェイスを構築する 1 つのユーザー アカウントの選択に多くの*](building-an-interface-to-select-one-user-account-from-many-cs.md)チュートリアルは、ページの場合は、各ユーザー アカウントを一覧表示するページを構築 GridView をフィルター処理します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="dedc2-123">グリッドには、各ユーザーの名前と電子メール、その承認済みおよびロックされた状態、現在オンラインいるかどうかおよびユーザーに関するコメントが一覧表示します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="dedc2-124">管理ユーザーの承認し、状態をロックアウトすることもできますこのグリッド編集可能です。</span><span class="sxs-lookup"><span data-stu-id="dedc2-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="dedc2-125">ユーザーの承認済みの状態を変更するには、管理者は最初ユーザー アカウントを見つけてチェックまたは承認済みのチェック ボックスをオフにする、対応する GridView の行を編集します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="dedc2-126">または、個別の ASP.NET ページから承認済みおよびロックされた状態を管理します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="dedc2-127">このチュートリアルでは 2 つの ASP.NET ページを使用してみましょう。`ManageUsers.aspx`と`UserInformation.aspx`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="dedc2-128">この考え方は`ManageUsers.aspx`システムでは、ユーザー アカウントを一覧表示中に`UserInformation.aspx`により、管理者は、特定のユーザーの承認済みおよびロックされた状態を管理します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="dedc2-129">最初の注文のビジネスで GridView を拡張する`ManageUsers.aspx`に含める、内では、リンクの列として表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="dedc2-130">各リンク先にする`UserInformation.aspx?user=UserName`ここで、 *UserName*を編集するユーザーの名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="dedc2-131">コードをダウンロードしている場合、 <a id="Tutorial13"> </a> [ *Recovering とパスワードを変更する*](recovering-and-changing-passwords-cs.md)チュートリアルはお気付きかもしれませんが、`ManageUsers.aspx`ページは、一連の既に含まれています"。"リンクを管理し、`UserInformation.aspx`ページ選択したユーザーのパスワードを変更するためのインターフェイスを提供します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="dedc2-132">メンバーシップ API を回避することと、ユーザーのパスワードを変更する SQL Server データベースを直接操作して、動作したので、このチュートリアルに関連付けられているコードでは、その機能をレプリケートしないようにしました。</span><span class="sxs-lookup"><span data-stu-id="dedc2-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="dedc2-133">このチュートリアルを使用して最初から開始、`UserInformation.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>


### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="dedc2-134">追加「管理」へのリンク、`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="dedc2-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="dedc2-135">開く、`ManageUsers.aspx`ページおよびを内の追加、 `UserAccounts` GridView。</span><span class="sxs-lookup"><span data-stu-id="dedc2-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="dedc2-136">セット内の`Text`"manage"プロパティとその`DataNavigateUrlFields`と`DataNavigateUrlFormatString`プロパティを`UserName`と"UserInformation.aspx?user={0}"、それぞれします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="dedc2-137">これらの設定は、テキスト"Manage"のハイパーリンクのすべての表示が各リンクは、適切なで合格するように、内を構成*UserName*に、クエリ文字列値。</span><span class="sxs-lookup"><span data-stu-id="dedc2-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="dedc2-138">GridView に追加すると、内、時間を表示するがかかる、`ManageUsers.aspx`ブラウザーを使用してページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="dedc2-139">図 1 に示す GridView 各行にはようになりました「管理」リンクが含まれます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="dedc2-140">Bruce の [管理] リンクを指す`UserInformation.aspx?user=Bruce`、Dave の [管理] リンクを指す`UserInformation.aspx?user=Dave`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>


<span data-ttu-id="dedc2-141">[![内に追加します。](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="dedc2-142">**図 1**: 内の各ユーザー アカウントの [管理] リンクを追加します ([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image3.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>


<span data-ttu-id="dedc2-143">ユーザー インターフェイスを作成しコードは、`UserInformation.aspx`みましょうトークで、時点が最初のページについて、ユーザーをプログラムで変更する方法のロックアウトし、承認の状態。</span><span class="sxs-lookup"><span data-stu-id="dedc2-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="dedc2-144">[ `MembershipUser`クラス](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)が[ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)と[`IsApproved`プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="dedc2-145">`IsLockedOut`プロパティは読み取り専用です。</span><span class="sxs-lookup"><span data-stu-id="dedc2-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="dedc2-146">プログラムでユーザーをロックアウトするメカニズムはありません。ユーザーのロックを解除するには、使用、`MembershipUser`クラスの[`UnlockUser`メソッド](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="dedc2-147">`IsApproved`プロパティは読み取りも書き込み可能です。</span><span class="sxs-lookup"><span data-stu-id="dedc2-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="dedc2-148">このプロパティに変更を保存する必要がありますを呼び出す、`Membership`クラスの[`UpdateUser`メソッド](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)、変更を渡して、`MembershipUser`オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="dedc2-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="dedc2-149">`IsApproved`プロパティは読み取りも書き込み可能な CheckBox コントロールは、このプロパティを構成するための最適なユーザー インターフェイス要素では可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="dedc2-150">ただし、チェック ボックスに対しては機能しません、`IsLockedOut`プロパティをユーザーのロック解除のみ可能性があります彼女管理者は、ユーザーをロックアウトことはできません、ためです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="dedc2-151">ための適切なユーザー インターフェイス、`IsLockedOut`プロパティは、ボタンをクリックすると、ユーザー アカウントのロックを解除します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="dedc2-152">このボタンは、ユーザーがロックアウトされた場合にのみ有効です。</span><span class="sxs-lookup"><span data-stu-id="dedc2-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="dedc2-153">作成、`UserInformation.aspx`ページ</span><span class="sxs-lookup"><span data-stu-id="dedc2-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="dedc2-154">ユーザー インターフェイスを実装する準備ができました`UserInformation.aspx`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="dedc2-155">このページを開き、次の Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="dedc2-156">クリックすると、ハイパーリンク コントロールによって、管理者を返します、`ManageUsers.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="dedc2-157">選択したユーザーの名前を表示するためのラベルの Web コントロール。</span><span class="sxs-lookup"><span data-stu-id="dedc2-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="dedc2-158">このラベルの設定`ID`に`UserNameLabel`クリアとその`Text`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="dedc2-159">という名前のチェック ボックス コントロール`IsApproved`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="dedc2-160">設定の`AutoPostBack`プロパティを`true`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="dedc2-161">ユーザーを表示するためのラベル コントロールでは日付最後のロックアウトします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="dedc2-162">このラベルの名前を付けます`LastLockedOutDateLabel`クリアとその`Text`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="dedc2-163">ユーザーのロックを解除するためのボタン。</span><span class="sxs-lookup"><span data-stu-id="dedc2-163">A Button for unlocking the user.</span></span> <span data-ttu-id="dedc2-164">このボタンを名前`UnlockUserButton`設定とその`Text`プロパティを「ユーザーのロックを解除」します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="dedc2-165">「ユーザーの承認済みの状態が更新されました」など、ステータス メッセージを表示するためのラベル コントロール</span><span class="sxs-lookup"><span data-stu-id="dedc2-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="dedc2-166">このコントロールの名前を付けます`StatusMessage`チェック ボックスをオフにその`Text`プロパティ、およびセットの`CssClass`プロパティを`Important`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="dedc2-167">(、`Important`で CSS クラスが定義されている、`Styles.css`スタイル シート ファイルは、大規模な赤いフォントで、対応するテキストが表示されます)。</span><span class="sxs-lookup"><span data-stu-id="dedc2-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="dedc2-168">これらのコントロールを追加すると、Visual Studio でデザイン ビューは図 2 でスクリーン ショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>


<span data-ttu-id="dedc2-169">[![UserInformation.aspx のユーザー インターフェイスを作成します。](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="dedc2-170">**図 2**: ユーザー インターフェイスを作成`UserInformation.aspx`([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image6.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>


<span data-ttu-id="dedc2-171">完全なユーザー インターフェイスでは、次のタスクを設定する、`IsApproved`チェック ボックスとその他のコントロールが選択したユーザーの情報に基づいています。</span><span class="sxs-lookup"><span data-stu-id="dedc2-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="dedc2-172">ページのイベント ハンドラーを作成`Load`イベントし、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="dedc2-173">上記のコードは、ページおよび以降のポストバックではないに初めてアクセスであることを確認して開始します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="dedc2-174">これは、後、を通じて渡されるユーザー名を読み取ります、`user`クエリ文字列フィールドを使用して、そのユーザー アカウントに関する情報を取得し、`Membership.GetUser(username)`メソッド。</span><span class="sxs-lookup"><span data-stu-id="dedc2-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="dedc2-175">クエリ文字列を通じてユーザー名が指定されていないか、管理者に送信される場合は、指定されたユーザーが見つかりませんでした、`ManageUsers.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="dedc2-176">`MembershipUser`オブジェクトの`UserName`に表示される値、`UserNameLabel`と`IsApproved`チェック ボックスをオンに基づき、`IsApproved`プロパティの値。</span><span class="sxs-lookup"><span data-stu-id="dedc2-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="dedc2-177">`MembershipUser`オブジェクトの[`LastLockoutDate`プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx)を返します、`DateTime`ロックされている場合、ユーザーが最後を示す値。ユーザーがロックアウトされていることはない場合、返される値は、メンバーシップ プロバイダーによって異なります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="dedc2-178">新しいアカウントが作成されたときに、`SqlMembershipProvider`設定、`aspnet_Membership`テーブルの`LastLockoutDate`フィールドを`1754-01-01 12:00:00 AM`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="dedc2-179">上記のコードで空の文字列が表示されます、`LastLockoutDateLabel`場合、`LastLockoutDate`プロパティが 1 年前に発生 2000。 それ以外の日付部分、`LastLockoutDate`ラベルのプロパティが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="dedc2-180">`UnlockUserButton'` S`Enabled`ロックの状態、つまり、ユーザーがロックアウトされた場合は、このボタンを有効のみがユーザーのプロパティが設定されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="dedc2-181">テストする少し、`UserInformation.aspx`ページがブラウザーを使用します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="dedc2-182">もちろんで開始する必要がありますが、`ManageUsers.aspx`を管理するユーザー アカウントを選択します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="dedc2-183">到着時に`UserInformation.aspx`、なお、`IsApproved`ユーザーが承認された場合、チェック ボックスをオンのみです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="dedc2-184">ユーザーがロックアウトされていることを最後の日付がロックアウトが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="dedc2-185">ユーザーが現在ロックアウトされる場合にのみ、ユーザーのロックを解除 ボタンが有効にします。オンまたはオフ、`IsApproved`チェック ボックスをオンまたはユーザーのロックを解除 ボタンをクリックしてが、ポストバックの原因が、変更がまったく加え、ユーザー アカウントにまだため、これらのイベントのイベント ハンドラーを作成します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="dedc2-186">Visual Studio に戻り、イベント ハンドラーを作成、`IsApproved`チェック ボックスの`CheckedChanged`イベントと`UnlockUser`ボタンの`Click`イベント。</span><span class="sxs-lookup"><span data-stu-id="dedc2-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="dedc2-187">`CheckedChanged`イベント ハンドラーでは、設定、ユーザーの`IsApproved`プロパティを`Checked`プロパティのチェック ボックスをオンにしてから、呼び出しに変更を保存`Membership.UpdateUser`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="dedc2-188">`Click`イベント ハンドラーでは、単に呼び出し、`MembershipUser`オブジェクトの`UnlockUser`メソッド。</span><span class="sxs-lookup"><span data-stu-id="dedc2-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="dedc2-189">両方のイベント ハンドラー内で適切なメッセージを表示、`StatusMessage`ラベル。</span><span class="sxs-lookup"><span data-stu-id="dedc2-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="dedc2-190">テスト、`UserInformation.aspx`ページ</span><span class="sxs-lookup"><span data-stu-id="dedc2-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="dedc2-191">これらのイベント ハンドラーで、ページに再アクセスおよび未承認ユーザー。</span><span class="sxs-lookup"><span data-stu-id="dedc2-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="dedc2-192">図 3 に示すようメッセージのことを示すページで、ユーザーの概要が表示されます`IsApproved`プロパティが正常に変更します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>


<span data-ttu-id="dedc2-193">[![Chris は未承認されました](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="dedc2-194">**図 3**: Chris は未承認されました ([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image9.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>


<span data-ttu-id="dedc2-195">次に、ログアウトし、アカウントを持つユーザーとしてログインしてください許可されませんでしただけです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="dedc2-196">ユーザーが承認されていないため、ログインできません。</span><span class="sxs-lookup"><span data-stu-id="dedc2-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="dedc2-197">既定では、Login コントロールでは、理由に関係なく、ユーザーがログインできない場合に、同じメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="dedc2-198">しかし、 <a id="Tutorial6"> </a> [*を検証するユーザーの資格情報に対して、メンバーシップ ユーザー ストア*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md)チュートリアルがより適切なメッセージを表示するログインの制御を強化しました。</span><span class="sxs-lookup"><span data-stu-id="dedc2-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="dedc2-199">図 4 に示す、Chris が自分のアカウントがまだ承認されていないため、彼ログインできないことを説明するメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>


<span data-ttu-id="dedc2-200">[![Chris できないログインのため His アカウントが未承認](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="dedc2-201">**図 4**: Chris できないログインのため His アカウントが未承認 ([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image12.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>


<span data-ttu-id="dedc2-202">ロックアウトの機能をテストするには、承認済みのユーザーとしてログインしますが、正しくないパスワードを使用を試みます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="dedc2-203">このプロセスに必要なユーザーのアカウントがロックアウトされてまでの時間数を繰り返します。Login コントロールは、カスタムの表示も更新されたメッセージの場合は、ロックアウトされたアカウントからログインしようとしています。</span><span class="sxs-lookup"><span data-stu-id="dedc2-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="dedc2-204">ログイン ページで、次のメッセージの表示を開始すると、アカウントがロックアウトされていることがわかって:"自分のアカウントがロックアウトされて無効なログインの回数が多すぎるためです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="dedc2-205">管理者に問い合わせてください、アカウントのロックを解除します。"</span><span class="sxs-lookup"><span data-stu-id="dedc2-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="dedc2-206">戻り、`ManageUsers.aspx`ページし、ロックアウトされたユーザーの管理 リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="dedc2-207">図 5 に示すように値が表示する必要があります、`LastLockedOutDateLabel`ユーザーのロックを解除 ボタンを有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="dedc2-208">ユーザー アカウントのロックを解除するユーザーのロックを解除 ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="dedc2-209">ユーザーのロックを解除すると、再度ログインできるされます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-209">Once you have unlocked the user, they will be able to login again.</span></span>


<span data-ttu-id="dedc2-210">[![Dave は、システムからロックアウトされている](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="dedc2-211">**図 5**: Dave がされているロックのうちシステム ([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image15.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>


## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="dedc2-212">手順 2: 新しいユーザーを指定する状態を承認</span><span class="sxs-lookup"><span data-stu-id="dedc2-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="dedc2-213">承認済みの状態は、何らかのアクションを新しいユーザーがログインして、サイトのユーザーに固有の機能にアクセスできるようにする前に実行するシナリオで役立ちます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="dedc2-214">たとえば、ログインとサインアップのページを除く、すべてのページが認証されたユーザーのみがアクセスできるプライベート web サイト実行される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="dedc2-215">ただし、知らない人が、web サイトに達した場合、サインアップ ページを検索し、アカウントを作成しますか。</span><span class="sxs-lookup"><span data-stu-id="dedc2-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="dedc2-216">これを防ぐへのサインアップ ページを移動する可能性があります、`Administration`フォルダー、および管理者が各アカウントを手動で作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="dedc2-217">または、だれもが、サインアップを許可することが管理者ユーザー アカウントを承認するまで、サイトへのアクセスを禁止できます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="dedc2-218">既定では、CreateUserWizard コントロールは、新しいアカウントを承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="dedc2-219">コントロールを使用してこの動作を構成する[`DisableCreatedUser`プロパティ](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="dedc2-220">このプロパティを設定`true`新しいユーザー アカウントを承認しません。</span><span class="sxs-lookup"><span data-stu-id="dedc2-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="dedc2-221">既定で CreateUserWizard コントロールは、新しいユーザー アカウントで自動的に記録します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="dedc2-222">この動作は、コントロールの規定[`LoginCreatedUser`プロパティ](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="dedc2-223">未承認ユーザーが、サイトにログインできないため、ときに`DisableCreatedUser`は`true`新しいユーザー アカウントがの値に関係なく、サイトにログインしていない、`LoginCreatedUser`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>


<span data-ttu-id="dedc2-224">プログラムで使用して、新しいユーザー アカウントを作成している場合、`Membership.CreateUser`メソッドは、未承認のユーザー アカウントを作成するを使用して、新しいユーザーの同意をオーバー ロードの 1 つ`IsApproved`入力パラメーターとしてプロパティ値。</span><span class="sxs-lookup"><span data-stu-id="dedc2-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="dedc2-225">手順 3: 電子メール アドレスを確認することでユーザーを承認します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="dedc2-226">登録するときに、指定した電子メール アドレスを確認するまで、ユーザー アカウントをサポートする多くの web サイトは新しいユーザーを承認されません。</span><span class="sxs-lookup"><span data-stu-id="dedc2-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="dedc2-227">この検証プロセスは、通常、検証済みの一意の電子メール アドレスが必要ですし、サインアップ プロセスで、追加の手順を追加します。 ボット、スパム、およびその他の役立たずを阻止するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="dedc2-228">このモデルでは、新しいユーザーはサインアップ時に送信されます検証ページへのリンクを含む電子メール メッセージ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="dedc2-229">リンクにアクセスして、ユーザーは、電子メールを受信して、有効なそのためが電子メール アドレスを指定することを実証されました。</span><span class="sxs-lookup"><span data-stu-id="dedc2-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="dedc2-230">確認 ページは、ユーザーの承認を担当します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="dedc2-231">これが発生する、自動的にこのページに到達できるすべてのユーザーを承認するため、ユーザーがなどいくつか追加の情報を提供した後にのみ、または、 [CAPTCHA](http://en.wikipedia.org/wiki/Captcha)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="dedc2-232">このワークフローを対応するためには、まず、アカウント作成ページを更新すると、新しいユーザーが承認されていない必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="dedc2-233">開く、`EnhancedCreateUserWizard.aspx`ページで、`Membership`フォルダーおよび CreateUserWizard コントロールをセット`DisableCreatedUser`プロパティを`true`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="dedc2-234">次に、自分のアカウントを確認する方法の手順で新しいユーザーに電子メールを送信する CreateUserWizard コントロールを構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="dedc2-235">電子メールに記載のリンクを含める具体的には、`Verification.aspx`ページ (まだこれを作成)、新しいユーザーに渡して、`UserId`を通じて、クエリ文字列。</span><span class="sxs-lookup"><span data-stu-id="dedc2-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="dedc2-236">`Verification.aspx`ページは、指定されたユーザーを検索し、承認、としてマークします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="dedc2-237">新しいユーザーに確認メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="dedc2-238">CreateUserWizard コントロールから、電子メールを送信する次のように構成します。 その`MailDefinition`プロパティ適切にします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="dedc2-239">説明したように、 <a id="Tutorial13"> </a>[前のチュートリアル](recovering-and-changing-passwords-cs.md)、ChangePassword と PasswordRecovery コントロールを[`MailDefinition`プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx)と同様に動作します。CreateUserWizard コントロールの。</span><span class="sxs-lookup"><span data-stu-id="dedc2-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="dedc2-240">使用する、`MailDefinition`メールの配信を指定する必要があるプロパティ オプション`Web.config`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="dedc2-241">詳細についてを参照してください[ASP.NET で電子メールを送信する](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>


<span data-ttu-id="dedc2-242">という名前の新しい電子メール テンプレートを作成して開始`CreateUserWizard.txt`で、`EmailTemplates`フォルダー。</span><span class="sxs-lookup"><span data-stu-id="dedc2-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="dedc2-243">テンプレートについては、次のテキストを使用します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="dedc2-244">設定、 `MailDefinition'` s`BodyFileName`プロパティを"~/EmailTemplates/CreateUserWizard.txt"とその`Subject`プロパティを"自分の web サイトへようこそ!</span><span class="sxs-lookup"><span data-stu-id="dedc2-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="dedc2-245">アクティブ化してください、アカウントです。"</span><span class="sxs-lookup"><span data-stu-id="dedc2-245">Please activate your account."</span></span>

<span data-ttu-id="dedc2-246">なお、`CreateUserWizard.txt`電子メール テンプレートが含まれています、`<%VerificationUrl%>`プレース ホルダーです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="dedc2-247">これは、ような場合の URL、`Verification.aspx`ページに配置されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="dedc2-248">CreateUserWizard が自動的に置き換えられます、`<%UserName%>`と`<%Password%>`プレース ホルダーを新しいアカウントのユーザー名とパスワード、組み込みはありませんが、`<%VerificationUrl%>`プレース ホルダーです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="dedc2-249">適切な検証 URL を使用して手動で置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="dedc2-250">これを実現するには、CreateUserWizard のイベント ハンドラーを作成[`SendingMail`イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx)し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="dedc2-251">`SendingMail`イベントが発生した後、`CreatedUser`イベント、上記のイベント ハンドラーは、新しいユーザーを実行するとき、アカウントが既に作成されたことを意味します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="dedc2-252">新しいユーザーのアクセス`UserId`呼び出すことによって値、`Membership.GetUser`に渡して、メソッド、 `UserName` CreateUserWizard コントロールに入力します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="dedc2-253">次に、検証 URL が形成されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="dedc2-254">ステートメント`Request.Url.GetLeftPart(UriPartial.Authority)`を返します、 `http://yourserver.com` ; URL の部分`Request.ApplicationPath`を返します。 パスが、アプリケーションのルートが指定されています。</span><span class="sxs-lookup"><span data-stu-id="dedc2-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="dedc2-255">URL として定義し、検証`Verification.aspx?ID=userId`です。</span><span class="sxs-lookup"><span data-stu-id="dedc2-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="dedc2-256">これら 2 つの文字列は、完全な URL をフォームに連結されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="dedc2-257">最後に、電子メール メッセージの本文 (`e.Message.Body`) が出現するすべての`<%VerificationUrl%>`の完全な URL に置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="dedc2-258">実質的な効果は、ある新しいユーザー承認されていない、つまりことは、サイトにログインすることはできません。</span><span class="sxs-lookup"><span data-stu-id="dedc2-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="dedc2-259">さらに、自動的に送信される電子メールのリンクを検証 URL (図 6 参照)。</span><span class="sxs-lookup"><span data-stu-id="dedc2-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>


<span data-ttu-id="dedc2-260">[![新しいユーザー検証 URL へのリンクを電子メールを受信します。](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="dedc2-261">**図 6**: 新しいユーザー検証 URL へのリンクを電子メールの受信 ([フルサイズの画像を表示する をクリックします](unlocking-and-approving-user-accounts-cs/_static/image18.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>


> [!NOTE]
> <span data-ttu-id="dedc2-262">CreateUserWizard コントロールの既定の CreateUserWizard の手順では、自分のアカウントが作成され、[続行] ボタンを表示、ユーザーに通知するメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="dedc2-263">これをクリックすると、ユーザーをコントロールの指定された URL が`ContinueDestinationPageUrl`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="dedc2-264">CreateUserWizard`EnhancedCreateUserWizard.aspx`新しいユーザーに送信するように構成、`~/Membership/AdditionalUserInfo.aspx`出身、ホームページの URL、および署名のユーザーが求められます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="dedc2-265">この情報できますのみ追加するためログオン ユーザー、理にかなってサイトのホーム ページにユーザーを送信するには、このプロパティを更新 (`~/Default.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="dedc2-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="dedc2-266">さらに、`EnhancedCreateUserWizard.aspx`検証電子メールが送信された、まで、このメールの指示に従いますが、自分のアカウントをアクティブ化されませんユーザーに通知するページまたは CreateUserWizard の手順を拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dedc2-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="dedc2-267">リーダーの練習としてこのような変更のままは。</span><span class="sxs-lookup"><span data-stu-id="dedc2-267">I leave these modifications as an exercise for the reader.</span></span>


### <a name="creating-the-verification-page"></a><span data-ttu-id="dedc2-268">確認ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-268">Creating the Verification Page</span></span>

<span data-ttu-id="dedc2-269">最後のタスクが作成するには、`Verification.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="dedc2-270">このページを関連付けることで、ルート フォルダーに追加、`Site.master`マスター ページ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="dedc2-271">ほとんどのサイトに追加する前のコンテンツ ページを参照するコンテンツ コントロールを削除、 `LoginContent` ContentPlaceHolder コンテンツ ページで、マスター ページを使用するよう既定のコンテンツ。</span><span class="sxs-lookup"><span data-stu-id="dedc2-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="dedc2-272">ラベル Web コントロールを追加、`Verification.aspx`設定ページで、その`ID`に`StatusMessage`しその text プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="dedc2-273">次に、作成、`Page_Load`イベント ハンドラーを次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="dedc2-274">上記のコードの大部分を検証する、 `UserId` 、クエリ文字列が存在する、有効であることを指定した`Guid`値、および既存のユーザー アカウントを参照していること。</span><span class="sxs-lookup"><span data-stu-id="dedc2-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="dedc2-275">ユーザー アカウントが承認されたすべてのこれらのチェックを渡す場合それ以外の場合、適切な状態メッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="dedc2-276">図 7 に示します、`Verification.aspx`ページをブラウザーからアクセスする場合。</span><span class="sxs-lookup"><span data-stu-id="dedc2-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>


<span data-ttu-id="dedc2-277">[![新しいユーザーのアカウントが承認されるようになりました](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="dedc2-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="dedc2-278">**図 7**: [新しいユーザーのアカウントが承認されるようになりました ([フルサイズの画像を表示する] をクリックします](unlocking-and-approving-user-accounts-cs/_static/image21.png))。</span><span class="sxs-lookup"><span data-stu-id="dedc2-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>


## <a name="summary"></a><span data-ttu-id="dedc2-279">まとめ</span><span class="sxs-lookup"><span data-stu-id="dedc2-279">Summary</span></span>

<span data-ttu-id="dedc2-280">すべてのメンバーシップ ユーザーのアカウントがあるユーザーがサイトにログインできるかどうかを決定する 2 つの状態:`IsLockedOut`と`IsApproved`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="dedc2-281">これらのプロパティの両方があります`true`ユーザーがログインするためです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="dedc2-282">ユーザーのロックアウト状態は、ブルート フォース攻撃の方法でサイトに重大なハッカーの可能性を低く、セキュリティ対策として使用されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="dedc2-283">具体的には、ユーザーがロックアウト時間帯内で無効なログイン試行数がある場合。</span><span class="sxs-lookup"><span data-stu-id="dedc2-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="dedc2-284">これらの境界は、メンバーシップ プロバイダーの設定で使用して構成できます`Web.config`します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="dedc2-285">承認済みの状態は、新しいユーザーが何らかのアクションが指定されるまでログ記録することを禁止するための手段として通常使用されます。</span><span class="sxs-lookup"><span data-stu-id="dedc2-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="dedc2-286">おそらく、サイトでは最初に新しいアカウントを管理者が承認することが必要ですか、電子メール アドレスを確認し、手順 3. で説明したようにします。</span><span class="sxs-lookup"><span data-stu-id="dedc2-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="dedc2-287">満足のプログラミングです。</span><span class="sxs-lookup"><span data-stu-id="dedc2-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="dedc2-288">執筆者紹介</span><span class="sxs-lookup"><span data-stu-id="dedc2-288">About the Author</span></span>

<span data-ttu-id="dedc2-289">Scott Mitchell、複数の受け取ります書籍の著者と、4GuysFromRolla.com の創設者では、1998 年から、Microsoft Web テクノロジに取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="dedc2-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="dedc2-290">Scott は、フリーのコンサルタント、トレーナー、およびライターとして動作します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="dedc2-291">最新の著書は *[Sams 教える自分で ASP.NET 2.0 24 時間以内に](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="dedc2-292">Scott に到達できる[ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)または彼のブログ[ http://ScottOnWriting.NET](http://scottonwriting.net/)します。</span><span class="sxs-lookup"><span data-stu-id="dedc2-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="dedc2-293">特別に感謝しています.</span><span class="sxs-lookup"><span data-stu-id="dedc2-293">Special Thanks To…</span></span>

<span data-ttu-id="dedc2-294">このチュートリアル シリーズは、多くの便利なレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="dedc2-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="dedc2-295">今後、MSDN の記事を確認したいですか。</span><span class="sxs-lookup"><span data-stu-id="dedc2-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="dedc2-296">場合は、筆者に [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="dedc2-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="dedc2-297">[前へ](recovering-and-changing-passwords-cs.md)
> [次へ](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="dedc2-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
