---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb
title: ASP.NET ページ (VB) で BLL レベルと DAL レベルの例外処理 |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、挿入、更新、または削除操作の中に例外が発生する必要があります、親しみやすい、わかりやすいエラー メッセージを表示する方法をわかる.
ms.author: aspnetcontent
manager: wpickett
ms.date: 07/17/2006
ms.topic: article
ms.assetid: 129d4338-1315-4f40-89b5-2b84b807707d
ms.technology: dotnet-webforms
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb
msc.type: authoredcontent
ms.openlocfilehash: 41a0ec0db4cb2093d7fadd2de7e65ee4874f0063
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/03/2018
ms.locfileid: "37394684"
---
<a name="handling-bll--and-dal-level-exceptions-in-an-aspnet-page-vb"></a><span data-ttu-id="470b3-103">ASP.NET ページ (VB) で BLL レベルと DAL レベルの例外処理</span><span class="sxs-lookup"><span data-stu-id="470b3-103">Handling BLL- and DAL-Level Exceptions in an ASP.NET Page (VB)</span></span>
====================
<span data-ttu-id="470b3-104">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="470b3-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="470b3-105">[サンプル アプリをダウンロード](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_VB.exe)または[PDF のダウンロード](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/datatutorial18vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="470b3-105">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_VB.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/datatutorial18vb1.pdf)</span></span>

> <span data-ttu-id="470b3-106">このチュートリアルは、挿入、更新、または ASP.NET データ Web コントロールの削除操作中に例外が発生する必要があります、親しみやすい、わかりやすいエラー メッセージを表示する方法が表示されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-106">In this tutorial we will see how to display a friendly, informative error message should an exception occur during an insert, update, or delete operation of an ASP.NET data Web control.</span></span>


## <a name="introduction"></a><span data-ttu-id="470b3-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="470b3-107">Introduction</span></span>

<span data-ttu-id="470b3-108">階層化されたアプリケーション アーキテクチャを使用して ASP.NET web アプリケーションからのデータの操作には、次の 3 つの一般的な手順が含まれます。</span><span class="sxs-lookup"><span data-stu-id="470b3-108">Working with data from an ASP.NET web application using a tiered application architecture involves the following three general steps:</span></span>

1. <span data-ttu-id="470b3-109">ビジネス ロジック層のどのようなメソッドが呼び出される必要があり、どのようなパラメーターの値を渡すことを確認します。</span><span class="sxs-lookup"><span data-stu-id="470b3-109">Determine what method of the Business Logic Layer needs to be invoked and what parameter values to pass it.</span></span> <span data-ttu-id="470b3-110">パラメーターの値は、ハード コーディングされたは、プログラムによって割り当てまたは入力がユーザーによって入力します。</span><span class="sxs-lookup"><span data-stu-id="470b3-110">The parameter values can be hard coded, programmatically-assigned, or inputs entered by the user.</span></span>
2. <span data-ttu-id="470b3-111">メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="470b3-111">Invoke the method.</span></span>
3. <span data-ttu-id="470b3-112">結果を処理します。</span><span class="sxs-lookup"><span data-stu-id="470b3-112">Process the results.</span></span> <span data-ttu-id="470b3-113">データを返す BLL メソッドを呼び出すときに、データ Web コントロールにデータをバインドこれが含まれる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="470b3-113">When calling a BLL method that returns data, this may involve binding the data to a data Web control.</span></span> <span data-ttu-id="470b3-114">BLL メソッドのデータを変更する場合は、何らかのアクションは、戻り値に基づくまたはに手順 2. で発生した例外を適切に処理を実行するこの含めることができます。</span><span class="sxs-lookup"><span data-stu-id="470b3-114">For BLL methods that modify data, this may include performing some action based on a return value or gracefully handling any exception that arose in Step 2.</span></span>

<span data-ttu-id="470b3-115">説明したように、[前のチュートリアル](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md)ObjectDataSource とデータ Web コントロールの両方は、手順 1. と 3. の拡張ポイントを提供します。</span><span class="sxs-lookup"><span data-stu-id="470b3-115">As we saw in the [previous tutorial](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md), both the ObjectDataSource and the data Web controls provide extensibility points for Steps 1 and 3.</span></span> <span data-ttu-id="470b3-116">GridView、たとえば、発生の`RowUpdating`にその ObjectDataSource のフィールドの値を割り当てる前にイベント`UpdateParameters`コレクション、 `RowUpdated` ObjectDataSource には、操作が完了した後にイベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="470b3-116">The GridView, for example, fires its `RowUpdating` event prior to assigning its field values to its ObjectDataSource's `UpdateParameters` collection; its `RowUpdated` event is raised after the ObjectDataSource has completed the operation.</span></span>

<span data-ttu-id="470b3-117">手順 1 の中に発生し、それらを使用して入力パラメーターをカスタマイズするか、操作をキャンセルする方法を見てきましたが、イベントを既にについて説明しました。</span><span class="sxs-lookup"><span data-stu-id="470b3-117">We've already examined the events that fire during Step 1 and have seen how they can be used to customize the input parameters or cancel the operation.</span></span> <span data-ttu-id="470b3-118">このチュートリアルでは、操作が完了した後に発生するイベントを有効にします。</span><span class="sxs-lookup"><span data-stu-id="470b3-118">In this tutorial we'll turn our attention to the events that fire after the operation has completed.</span></span> <span data-ttu-id="470b3-119">その他のものは、これらの投稿レベルのイベント ハンドラーで操作中に例外が発生したかどうかを確認し、既定では、標準の ASP.NET ではなく、親しみやすい、わかりやすいエラー メッセージを表示する画面に正常に処理例外ページ。</span><span class="sxs-lookup"><span data-stu-id="470b3-119">With these post-level event handlers we can, among other things, determine if an exception occurred during the operation and handle it gracefully, displaying a friendly, informative error message on the screen rather than defaulting to the standard ASP.NET exception page.</span></span>

<span data-ttu-id="470b3-120">これらの投稿レベルのイベントの処理を示すためには、編集可能な GridView では、製品を一覧表示されたページを作成しましょう。</span><span class="sxs-lookup"><span data-stu-id="470b3-120">To illustrate working with these post-level events, let's create a page that lists the products in an editable GridView.</span></span> <span data-ttu-id="470b3-121">例外の場合、製品の更新が、ASP.NET に発生したときにページに問題が発生したことを説明する GridView の上に短いメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-121">When updating a product, if an exception is raised our ASP.NET page will display a short message above the GridView explaining that a problem has occurred.</span></span> <span data-ttu-id="470b3-122">それでは、始めましょう!</span><span class="sxs-lookup"><span data-stu-id="470b3-122">Let's get started!</span></span>

## <a name="step-1-creating-an-editable-gridview-of-products"></a><span data-ttu-id="470b3-123">手順 1: 製品の編集可能な GridView を作成します。</span><span class="sxs-lookup"><span data-stu-id="470b3-123">Step 1: Creating an Editable GridView of Products</span></span>

<span data-ttu-id="470b3-124">前のチュートリアルでは 2 つのフィールドを編集可能な GridView を作成した`ProductName`と`UnitPrice`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-124">In the previous tutorial we created an editable GridView with just two fields, `ProductName` and `UnitPrice`.</span></span> <span data-ttu-id="470b3-125">この必須の追加のオーバー ロードを作成、`ProductsBLL`クラスの`UpdateProduct`メソッドは、次の 3 つの入力パラメーター (製品の名前、unit price、および ID) に製品の各フィールドの対照的パラメーターのみを許可します。</span><span class="sxs-lookup"><span data-stu-id="470b3-125">This required creating an additional overload for the `ProductsBLL` class's `UpdateProduct` method, one that only accepted three input parameters (the product's name, unit price, and ID) as opposed a parameter for each product field.</span></span> <span data-ttu-id="470b3-126">このチュートリアルでは、この手法、もう一度作成、編集可能な GridView、在庫製品の名前、unit、unit price、およびユニットあたりの数量が表示されますが、名、unit price、および単位を編集する在庫でしか使用を実践しましょう。</span><span class="sxs-lookup"><span data-stu-id="470b3-126">For this tutorial, let's practice this technique again, creating an editable GridView that displays the product's name, quantity per unit, unit price, and units in stock, but only allows the name, unit price, and units in stock to be edited.</span></span>

<span data-ttu-id="470b3-127">このシナリオに対応する必要がありますの別のオーバー ロード、`UpdateProduct`メソッドは、4 つのパラメーターを受け取る 1: 製品の名前、単価、在庫、および ID の単位</span><span class="sxs-lookup"><span data-stu-id="470b3-127">To accommodate this scenario we'll need another overload of the `UpdateProduct` method, one that accepts four parameters: the product's name, unit price, units in stock, and ID.</span></span> <span data-ttu-id="470b3-128">次のメソッドを追加、`ProductsBLL`クラス。</span><span class="sxs-lookup"><span data-stu-id="470b3-128">Add the following method to the `ProductsBLL` class:</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample1.vb)]

<span data-ttu-id="470b3-129">この方法で完全なこれら 4 つの特定の製品フィールドを編集できます。 ASP.NET ページを作成する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="470b3-129">With this method complete, we're ready to create the ASP.NET page that allows for editing these four particular product fields.</span></span> <span data-ttu-id="470b3-130">開く、`ErrorHandling.aspx`ページで、`EditInsertDelete`フォルダー、デザイナーを使用してページに GridView を追加します。</span><span class="sxs-lookup"><span data-stu-id="470b3-130">Open the `ErrorHandling.aspx` page in the `EditInsertDelete` folder and add a GridView to the page through the Designer.</span></span> <span data-ttu-id="470b3-131">新しい ObjectDataSource では、GridView にバインド マッピング、`Select()`メソッドを`ProductsBLL`クラスの`GetProducts()`メソッドと`Update()`メソッドを`UpdateProduct`オーバー ロードを作成します。</span><span class="sxs-lookup"><span data-stu-id="470b3-131">Bind the GridView to a new ObjectDataSource, mapping the `Select()` method to the `ProductsBLL` class's `GetProducts()` method and the `Update()` method to the `UpdateProduct` overload just created.</span></span>


<span data-ttu-id="470b3-132">[![次の 4 つの入力パラメーターを受け取る UpdateProduct メソッド オーバー ロードを使用します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-132">[![Use the UpdateProduct Method Overload That Accepts Four Input Parameters](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image1.png)</span></span>

<span data-ttu-id="470b3-133">**図 1**: 使用して、`UpdateProduct`メソッドをオーバー ロードすることを受け入れる次の 4 つ入力パラメーター ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image3.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-133">**Figure 1**: Use the `UpdateProduct` Method Overload That Accepts Four Input Parameters ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image3.png))</span></span>


<span data-ttu-id="470b3-134">これで、ObjectDataSource が作成されます、 `UpdateParameters` 4 つのパラメーターおよびフィールドを持つ GridView の各製品のフィールドのコレクション。</span><span class="sxs-lookup"><span data-stu-id="470b3-134">This will create an ObjectDataSource with an `UpdateParameters` collection with four parameters and a GridView with a field for each of the product fields.</span></span> <span data-ttu-id="470b3-135">ObjectDataSource の宣言型マークアップを割り当てます、`OldValuesParameterFormatString`プロパティ値`original_{0}`、という名前の入力パラメーターの予定がない、BLL クラスのために例外が発生する`original_productID`で渡されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-135">The ObjectDataSource's declarative markup assigns the `OldValuesParameterFormatString` property the value `original_{0}`, which will cause an exception since our BLL class's don't expect an input parameter named `original_productID` to be passed in.</span></span> <span data-ttu-id="470b3-136">この設定を完全宣言型構文を削除することを忘れないでください (既定の値に設定または`{0}`)。</span><span class="sxs-lookup"><span data-stu-id="470b3-136">Don't forget to remove this setting altogether from the declarative syntax (or set it to the default value, `{0}`).</span></span>

<span data-ttu-id="470b3-137">次に、のみを含む GridView ところを省く、 `ProductName`、 `QuantityPerUnit`、 `UnitPrice`、および`UnitsInStock`BoundFields します。</span><span class="sxs-lookup"><span data-stu-id="470b3-137">Next, pare down the GridView to include only the `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` BoundFields.</span></span> <span data-ttu-id="470b3-138">自由と思われるために必要なフィールド レベルの書式を適用する (変更など、`HeaderText`プロパティ)。</span><span class="sxs-lookup"><span data-stu-id="470b3-138">Also feel free to apply any field-level formatting you deem necessary (such as changing the `HeaderText` properties).</span></span>

<span data-ttu-id="470b3-139">前のチュートリアルで書式を設定する方法を説明しました、 `UnitPrice` BoundField 読み取り専用モードと編集モードの両方の通貨として。</span><span class="sxs-lookup"><span data-stu-id="470b3-139">In the previous tutorial we looked at how to format the `UnitPrice` BoundField as a currency both in read-only mode and edit mode.</span></span> <span data-ttu-id="470b3-140">同じここで見ていきます。</span><span class="sxs-lookup"><span data-stu-id="470b3-140">Let's do the same here.</span></span> <span data-ttu-id="470b3-141">BoundField の設定が必要ですこのことを思い出してください`DataFormatString`プロパティを`{0:c}`その`HtmlEncode`プロパティを`false`、およびその`ApplyFormatInEditMode`に`true`図 2 に示すように、します。</span><span class="sxs-lookup"><span data-stu-id="470b3-141">Recall that this required setting the BoundField's `DataFormatString` property to `{0:c}`, its `HtmlEncode` property to `false`, and its `ApplyFormatInEditMode` to `true`, as shown in Figure 2.</span></span>


<span data-ttu-id="470b3-142">[![通貨として表示する UnitPrice BoundField を構成します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-142">[![Configure the UnitPrice BoundField to Display as a Currency](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image4.png)</span></span>

<span data-ttu-id="470b3-143">**図 2**: 構成、 `UnitPrice` BoundField を通貨として表示する ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image6.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-143">**Figure 2**: Configure the `UnitPrice` BoundField to Display as a Currency ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image6.png))</span></span>


<span data-ttu-id="470b3-144">書式設定、`UnitPrice`編集インターフェイスでの通貨での GridView のイベント ハンドラーの作成を必要とされる`RowUpdating`を通貨形式の文字列を解析するイベントを`decimal`値。</span><span class="sxs-lookup"><span data-stu-id="470b3-144">Formatting the `UnitPrice` as a currency in the editing interface requires creating an event handler for the GridView's `RowUpdating` event that parses the currency-formatted string into a `decimal` value.</span></span> <span data-ttu-id="470b3-145">いることを思い出してください、`RowUpdating`の最後のチュートリアルからのイベント ハンドラーが、ユーザーが指定したことを確認するチェックもを`UnitPrice`値。</span><span class="sxs-lookup"><span data-stu-id="470b3-145">Recall that the `RowUpdating` event handler from the last tutorial also checked to ensure that the user provided a `UnitPrice` value.</span></span> <span data-ttu-id="470b3-146">ただし、このチュートリアルでは、価格を省略するユーザーがみましょう。</span><span class="sxs-lookup"><span data-stu-id="470b3-146">However, for this tutorial let's allow the user to omit the price.</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample2.vb)]

<span data-ttu-id="470b3-147">含まれています、GridView、 `QuantityPerUnit` BoundField がこの BoundField 表示用のみにする必要があり、ユーザーは編集できません。</span><span class="sxs-lookup"><span data-stu-id="470b3-147">Our GridView includes a `QuantityPerUnit` BoundField, but this BoundField should be only for display purposes and should not be editable by the user.</span></span> <span data-ttu-id="470b3-148">これを配置する BoundFields' を設定するだけ`ReadOnly`プロパティを`true`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-148">To arrange this, simply set the BoundFields' `ReadOnly` property to `true`.</span></span>


<span data-ttu-id="470b3-149">[![読み取り専用 QuantityPerUnit BoundField を行う](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-149">[![Make the QuantityPerUnit BoundField Read-Only](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image7.png)</span></span>

<span data-ttu-id="470b3-150">**図 3**: 作成、 `QuantityPerUnit` BoundField 読み取り専用 ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image9.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-150">**Figure 3**: Make the `QuantityPerUnit` BoundField Read-Only ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image9.png))</span></span>


<span data-ttu-id="470b3-151">最後に、GridView のスマート タグの編集を有効にするチェック ボックスを確認します。</span><span class="sxs-lookup"><span data-stu-id="470b3-151">Finally, check the Enable Editing checkbox from the GridView's smart tag.</span></span> <span data-ttu-id="470b3-152">次の手順を完了した後、`ErrorHandling.aspx`ページのデザイナーはよう図 4 になります。</span><span class="sxs-lookup"><span data-stu-id="470b3-152">After completing these steps the `ErrorHandling.aspx` page's Designer should look similar to Figure 4.</span></span>


<span data-ttu-id="470b3-153">[![すべて削除、必要な BoundFields とチェック チェック ボックスの編集を有効にします。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-153">[![Remove All But the Needed BoundFields and Check the Enable Editing Checkbox](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image10.png)</span></span>

<span data-ttu-id="470b3-154">**図 4**: 削除以外のすべての必要な BoundFields とチェックを有効にする編集ボックスをオン ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image12.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-154">**Figure 4**: Remove All But the Needed BoundFields and Check the Enable Editing Checkbox ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image12.png))</span></span>


<span data-ttu-id="470b3-155">この時点でのすべての製品の一覧がある`ProductName`、 `QuantityPerUnit`、 `UnitPrice`、および`UnitsInStock`フィールドです。 ただし、のみ、 `ProductName`、 `UnitPrice`、と`UnitsInStock`のフィールドを編集できます。</span><span class="sxs-lookup"><span data-stu-id="470b3-155">At this point we have a list of all of the products' `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` fields; however, only the `ProductName`, `UnitPrice`, and `UnitsInStock` fields can be edited.</span></span>


<span data-ttu-id="470b3-156">[![ユーザー今すぐ簡単に編集できます製品の名前、価格、およびストック フィールド内のユニット](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-156">[![Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image13.png)</span></span>

<span data-ttu-id="470b3-157">**図 5**: ユーザーできます今すぐ簡単に編集の製品の名前、価格、および単位で在庫フィールド ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image15.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-157">**Figure 5**: Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image15.png))</span></span>


## <a name="step-2-gracefully-handling-dal-level-exceptions"></a><span data-ttu-id="470b3-158">手順 2: DAL レベルの例外を適切に処理します。</span><span class="sxs-lookup"><span data-stu-id="470b3-158">Step 2: Gracefully Handling DAL-Level Exceptions</span></span>

<span data-ttu-id="470b3-159">編集可能な GridView は、ユーザーが編集された製品の名前、価格、および在庫数の有効な値を入力するときにすばらしく、不正な値を入力することで例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="470b3-159">While our editable GridView works wonderfully when users enter legal values for the edited product's name, price, and units in stock, entering illegal values results in an exception.</span></span> <span data-ttu-id="470b3-160">などを省略すると、`ProductName`値の原因を[NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp)からスローされる、`ProductName`プロパティ、`ProdcutsRow`クラスがその`AllowDBNull`プロパティに設定`false`場合、データベースが、停止、`SqlException`データベースに接続するときに、TableAdapter がスローされます。</span><span class="sxs-lookup"><span data-stu-id="470b3-160">For example, omitting the `ProductName` value causes a [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) to be thrown since the `ProductName` property in the `ProdcutsRow` class has its `AllowDBNull` property set to `false`; if the database is down, a `SqlException` will be thrown by the TableAdapter when attempting to connect to the database.</span></span> <span data-ttu-id="470b3-161">操作を行わずに、これらの例外バブル アップ データ アクセス層からビジネス ロジック層で、[ASP.NET] ページで、最後に、ASP.NET ランタイムにします。</span><span class="sxs-lookup"><span data-stu-id="470b3-161">Without taking any action, these exceptions bubble up from the Data Access Layer to the Business Logic Layer, then to the ASP.NET page, and finally to the ASP.NET runtime.</span></span>

<span data-ttu-id="470b3-162">Web アプリケーションを構成する方法と、アプリケーションからアクセスしているかどうかに応じて`localhost`、ハンドルされない例外が発生する一般的なサーバー エラー ページ、詳細なエラー レポート、またはユーザー フレンドリな web ページのいずれかにします。</span><span class="sxs-lookup"><span data-stu-id="470b3-162">Depending on how your web application is configured and whether or not you're visiting the application from `localhost`, an unhandled exception can result in either a generic server-error page, a detailed error report, or a user-friendly web page.</span></span> <span data-ttu-id="470b3-163">参照してください[ASP.NET のアプリケーション エラーの処理を Web](http://www.15seconds.com/issue/030102.htm)と[customErrors 要素](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx)ASP.NET ランタイムが、キャッチされない例外に応答する方法の詳細についてはします。</span><span class="sxs-lookup"><span data-stu-id="470b3-163">See [Web Application Error Handling in ASP.NET](http://www.15seconds.com/issue/030102.htm) and the [customErrors Element](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) for more information on how the ASP.NET runtime responds to an uncaught exception.</span></span>

<span data-ttu-id="470b3-164">図 6 を指定せず、製品を更新する際に発生した画面を示しています、`ProductName`値。</span><span class="sxs-lookup"><span data-stu-id="470b3-164">Figure 6 shows the screen encountered when attempting to update a product without specifying the `ProductName` value.</span></span> <span data-ttu-id="470b3-165">これは、既定の送信されるときに詳細なエラー レポートが表示される`localhost`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-165">This is the default detailed error report displayed when coming through `localhost`.</span></span>


<span data-ttu-id="470b3-166">[![製品の名前が表示されます例外の詳細を省略します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-166">[![Omitting the Product's Name Will Display Exception Details](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image16.png)</span></span>

<span data-ttu-id="470b3-167">**図 6**: 製品の名前は例外の詳細を表示を省略すると ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image18.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-167">**Figure 6**: Omitting the Product's Name Will Display Exception Details ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image18.png))</span></span>


<span data-ttu-id="470b3-168">このような例外の詳細は、アプリケーションをテストするときに便利ですが、例外が発生した場合、このような画面で、エンド ユーザーを表示するは未満に最適です。</span><span class="sxs-lookup"><span data-stu-id="470b3-168">While such exception details are helpful when testing an application, presenting an end user with such a screen in the face of an exception is less than ideal.</span></span> <span data-ttu-id="470b3-169">可能性の高いエンドユーザーが不明な`NoNullAllowedException`は理由が原因か。</span><span class="sxs-lookup"><span data-stu-id="470b3-169">An end user likely doesn't know what a `NoNullAllowedException` is or why it was caused.</span></span> <span data-ttu-id="470b3-170">製品を更新しようとしています。 問題があったことを説明するわかりやすいメッセージをユーザーに表示することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="470b3-170">A better approach is to present the user with a more user-friendly message explaining that there were problems attempting to update the product.</span></span>

<span data-ttu-id="470b3-171">操作を実行するときに、例外が発生する場合、ObjectDataSource とデータ Web コントロールの両方で投稿レベルのイベントは、それを検出し、ASP.NET ランタイムにバブルアップから例外をキャンセルするための手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="470b3-171">If an exception occurs when performing the operation, the post-level events in both the ObjectDataSource and the data Web control provide a means to detect it and cancel the exception from bubbling up to the ASP.NET runtime.</span></span> <span data-ttu-id="470b3-172">この例での GridView のみましょうイベント ハンドラーを作成`RowUpdated`イベントとを決定するかどうか、例外が発生した、そうである場合は、Label Web コントロールで例外の詳細を表示します。</span><span class="sxs-lookup"><span data-stu-id="470b3-172">For our example, let's create an event handler for the GridView's `RowUpdated` event that determines if an exception has fired and, if so, displays the exception details in a Label Web control.</span></span>

<span data-ttu-id="470b3-173">ASP.NET ページの設定にラベルを追加して、開始、`ID`プロパティを`ExceptionDetails`を消去して、`Text`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="470b3-173">Start by adding a Label to the ASP.NET page, setting its `ID` property to `ExceptionDetails` and clearing out its `Text` property.</span></span> <span data-ttu-id="470b3-174">このメッセージに、ユーザーの目を描画するために次のように設定します。 その`CssClass`プロパティを`Warning`、に追加の CSS クラスは、`Styles.css`前のチュートリアルでのファイル。</span><span class="sxs-lookup"><span data-stu-id="470b3-174">In order to draw the user's eye to this message, set its `CssClass` property to `Warning`, which is a CSS class we added to the `Styles.css` file in the previous tutorial.</span></span> <span data-ttu-id="470b3-175">この CSS クラスにより、ラベルのテキストは、赤、斜体、太字、特大のフォントで表示されることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="470b3-175">Recall that this CSS class causes the Label's text to be displayed in a red, italic, bold, extra large font.</span></span>


<span data-ttu-id="470b3-176">[![ラベルの Web コントロールをページに追加します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-176">[![Add a Label Web Control to the Page](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image19.png)</span></span>

<span data-ttu-id="470b3-177">**図 7**: ラベルの Web コントロールをページに追加 ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image21.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-177">**Figure 7**: Add a Label Web Control to the Page ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image21.png))</span></span>


<span data-ttu-id="470b3-178">例外が発生するこのラベルの Web コントロールは表示のみすぐにした後、設定、`Visible`プロパティを false に、`Page_Load`イベント ハンドラー。</span><span class="sxs-lookup"><span data-stu-id="470b3-178">Since we want this Label Web control to be visible only immediately after an exception has occurred, set its `Visible` property to false in the `Page_Load` event handler:</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample3.vb)]

<span data-ttu-id="470b3-179">以降のポストバックでは、最初のページ アクセスでは、次のコードで、`ExceptionDetails`コントロールが持つその`Visible`プロパティに設定`false`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-179">With this code, on the first page visit and subsequent postbacks the `ExceptionDetails` control will have its `Visible` property set to `false`.</span></span> <span data-ttu-id="470b3-180">GridView ので検出できる、DAL または BLL レベルの例外が発生した場合`RowUpdated`設定は、イベント ハンドラー、`ExceptionDetails`コントロールの`Visible`プロパティを true にします。</span><span class="sxs-lookup"><span data-stu-id="470b3-180">In the face of a DAL- or BLL-level exception, which we can detect in the GridView's `RowUpdated` event handler, we will set the `ExceptionDetails` control's `Visible` property to true.</span></span> <span data-ttu-id="470b3-181">Web コントロールのイベント ハンドラーの後に行われるため、`Page_Load`ページ ライフ サイクルのイベント ハンドラーをラベルが表示されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-181">Since Web control event handlers occur after the `Page_Load` event handler in the page lifecycle, the Label will be shown.</span></span> <span data-ttu-id="470b3-182">ただし、次のポストバックで、`Page_Load`イベント ハンドラーは元に戻す、`Visible`プロパティ`false`、もう一度ビューから非表示にします。</span><span class="sxs-lookup"><span data-stu-id="470b3-182">However, on the next postback, the `Page_Load` event handler will revert the `Visible` property back to `false`, hiding it from view again.</span></span>

> [!NOTE]
> <span data-ttu-id="470b3-183">設定の必要性を削除または、`ExceptionDetails`コントロールの`Visible`プロパティ`Page_Load`を割り当てることによってその`Visible`プロパティ`false`宣言の構文とそのビュー ステートを (そのの設定を無効にします。`EnableViewState`プロパティを`false`)。</span><span class="sxs-lookup"><span data-stu-id="470b3-183">Alternatively, we could remove the necessity for setting the `ExceptionDetails` control's `Visible` property in `Page_Load` by assigning its `Visible` property `false` in the declarative syntax and disabling its view state (setting its `EnableViewState` property to `false`).</span></span> <span data-ttu-id="470b3-184">今後のチュートリアルでは、この代替アプローチを使用します。</span><span class="sxs-lookup"><span data-stu-id="470b3-184">We'll use this alternative approach in a future tutorial.</span></span>


<span data-ttu-id="470b3-185">次の手順は GridView のイベント ハンドラーを作成する、ラベル コントロールを追加、`RowUpdated`イベント。</span><span class="sxs-lookup"><span data-stu-id="470b3-185">With the Label control added, our next step is to create the event handler for the GridView's `RowUpdated` event.</span></span> <span data-ttu-id="470b3-186">デザイナーで、GridView を選択、[プロパティ] ウィンドウに移動し、稲妻のアイコン、GridView のイベントを一覧表示をクリックします。</span><span class="sxs-lookup"><span data-stu-id="470b3-186">Select the GridView in the Designer, go to the Properties window, and click the lightning bolt icon, listing the GridView's events.</span></span> <span data-ttu-id="470b3-187">GridView のあるエントリはず`RowUpdating`イベント、このチュートリアルで前にこのイベントのイベント ハンドラーを作成しました。</span><span class="sxs-lookup"><span data-stu-id="470b3-187">There should already be an entry there for the GridView's `RowUpdating` event, as we created an event handler for this event earlier in this tutorial.</span></span> <span data-ttu-id="470b3-188">イベント ハンドラーを作成、`RowUpdated`イベントもします。</span><span class="sxs-lookup"><span data-stu-id="470b3-188">Create an event handler for the `RowUpdated` event as well.</span></span>


![GridView の RowUpdated イベントのイベント ハンドラーを作成します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image22.png)

<span data-ttu-id="470b3-190">**図 8**: の GridView のイベント ハンドラーを作成`RowUpdated`イベント</span><span class="sxs-lookup"><span data-stu-id="470b3-190">**Figure 8**: Create an Event Handler for the GridView's `RowUpdated` Event</span></span>


> [!NOTE]
> <span data-ttu-id="470b3-191">分離コード クラス ファイルの上部にあるドロップダウン リストにより、イベント ハンドラーを作成することもできます。</span><span class="sxs-lookup"><span data-stu-id="470b3-191">You can also create the event handler through the drop-down lists at the top of the code-behind class file.</span></span> <span data-ttu-id="470b3-192">GridView を左側のドロップダウン リストから選択し、`RowUpdated`右側の 1 つからのイベント。</span><span class="sxs-lookup"><span data-stu-id="470b3-192">Select the GridView from the drop-down list on the left and the `RowUpdated` event from the one on the right.</span></span>


<span data-ttu-id="470b3-193">このイベント ハンドラーを作成すると、次のコードが ASP.NET ページの分離コード クラスに追加されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-193">Creating this event handler will add the following code to the ASP.NET page's code-behind class:</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample4.vb)]

<span data-ttu-id="470b3-194">このイベント ハンドラーの 2 番目の入力パラメーターの型のオブジェクトは、 [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx)目的の例外を処理するための 3 つのプロパティを持ちます。</span><span class="sxs-lookup"><span data-stu-id="470b3-194">This event handler's second input parameter is an object of type [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), which has three properties of interest for handling exceptions:</span></span>

- <span data-ttu-id="470b3-195">`Exception` スローされた例外; への参照このプロパティの値には例外がスローされていない場合 `null`</span><span class="sxs-lookup"><span data-stu-id="470b3-195">`Exception` a reference to the thrown exception; if no exception has been thrown, this property will have a value of `null`</span></span>
- <span data-ttu-id="470b3-196">`ExceptionHandled` 例外が処理されたかどうかを示すブール値、`RowUpdated`イベント ハンドラー場合`false`(既定)、例外が再スローされますが、ASP.NET ランタイムまで percolating</span><span class="sxs-lookup"><span data-stu-id="470b3-196">`ExceptionHandled` a Boolean value that indicates whether or not the exception was handled in the `RowUpdated` event handler; if `false` (the default), the exception is re-thrown, percolating up to the ASP.NET runtime</span></span>
- <span data-ttu-id="470b3-197">`KeepInEditMode` 場合設定`true`場合に、編集した GridView 行が編集モードで保持`false`(既定)、GridView の行が、読み取り専用モードに戻ります</span><span class="sxs-lookup"><span data-stu-id="470b3-197">`KeepInEditMode` if set to `true` the edited GridView row remains in edit mode; if `false` (the default), the GridView row reverts back to its read-only mode</span></span>

<span data-ttu-id="470b3-198">次に、コードがかどうかを確認する必要があります`Exception`ない`null`操作の実行中に例外が発生したことを意味します。</span><span class="sxs-lookup"><span data-stu-id="470b3-198">Our code, then, should check to see if `Exception` is not `null`, meaning that an exception was raised while performing the operation.</span></span> <span data-ttu-id="470b3-199">この場合にします。</span><span class="sxs-lookup"><span data-stu-id="470b3-199">If this is the case, we want to:</span></span>

- <span data-ttu-id="470b3-200">わかりやすいメッセージを表示、`ExceptionDetails`ラベル</span><span class="sxs-lookup"><span data-stu-id="470b3-200">Display a user-friendly message in the `ExceptionDetails` Label</span></span>
- <span data-ttu-id="470b3-201">例外が処理されたことを示します</span><span class="sxs-lookup"><span data-stu-id="470b3-201">Indicate that the exception was handled</span></span>
- <span data-ttu-id="470b3-202">GridView の行を編集モードにしてください。</span><span class="sxs-lookup"><span data-stu-id="470b3-202">Keep the GridView row in edit mode</span></span>

<span data-ttu-id="470b3-203">この次のコードでは、これらの目標を実現します。</span><span class="sxs-lookup"><span data-stu-id="470b3-203">This following code accomplishes these objectives:</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample5.vb)]

<span data-ttu-id="470b3-204">このイベント ハンドラーが始まるかどうかをチェックして`e.Exception`は`null`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-204">This event handler begins by checking to see if `e.Exception` is `null`.</span></span> <span data-ttu-id="470b3-205">そうでない場合、`ExceptionDetails`ラベルの`Visible`プロパティに設定されて`true`とその`Text`プロパティを「問題があった、製品を更新しています」。</span><span class="sxs-lookup"><span data-stu-id="470b3-205">If it's not, the `ExceptionDetails` Label's `Visible` property is set to `true` and its `Text` property to "There was a problem updating the product."</span></span> <span data-ttu-id="470b3-206">スローされた実際の例外の詳細が存在する、`e.Exception`オブジェクトの`InnerException`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="470b3-206">The details of the actual exception that was thrown reside in the `e.Exception` object's `InnerException` property.</span></span> <span data-ttu-id="470b3-207">この内部例外を調べるしに、便利な追加のメッセージが追加されます、特定の型の場合、`ExceptionDetails`ラベルの`Text`プロパティ。</span><span class="sxs-lookup"><span data-stu-id="470b3-207">This inner exception is examined and, if it is of a particular type, an additional, helpful message is appended to the `ExceptionDetails` Label's `Text` property.</span></span> <span data-ttu-id="470b3-208">最後に、`ExceptionHandled`と`KeepInEditMode`プロパティに設定されて`true`します。</span><span class="sxs-lookup"><span data-stu-id="470b3-208">Lastly, the `ExceptionHandled` and `KeepInEditMode` properties are both set to `true`.</span></span>

<span data-ttu-id="470b3-209">図 9 は、製品の名前を省略する場合にこのページのスクリーン ショットを示します図 10 では、不正なを入力するときに、結果が表示されます`UnitPrice`値 (-50 の場合)。</span><span class="sxs-lookup"><span data-stu-id="470b3-209">Figure 9 shows a screen shot of this page when omitting the name of the product; Figure 10 shows the results when entering an illegal `UnitPrice` value (-50).</span></span>


<span data-ttu-id="470b3-210">[![ProductName BoundField が値を含める必要があります。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-210">[![The ProductName BoundField Must Contain a Value](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image23.png)</span></span>

<span data-ttu-id="470b3-211">**図 9**: `ProductName` BoundField が値を含める必要があります ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image25.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-211">**Figure 9**: The `ProductName` BoundField Must Contain a Value ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image25.png))</span></span>


<span data-ttu-id="470b3-212">[![UnitPrice の負の値は許可されていません](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-212">[![Negative UnitPrice Values are Not Allowed](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image26.png)</span></span>

<span data-ttu-id="470b3-213">**図 10**: 負`UnitPrice`値は許可されていません ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image28.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-213">**Figure 10**: Negative `UnitPrice` Values are Not Allowed ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image28.png))</span></span>


<span data-ttu-id="470b3-214">設定して、`e.ExceptionHandled`プロパティを`true`、`RowUpdated`イベント ハンドラーに例外を処理したことが示されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-214">By setting the `e.ExceptionHandled` property to `true`, the `RowUpdated` event handler has indicated that it has handled the exception.</span></span> <span data-ttu-id="470b3-215">そのため、例外が ASP.NET ランタイムに伝達されません。</span><span class="sxs-lookup"><span data-stu-id="470b3-215">Therefore, the exception won't propagate up to the ASP.NET runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="470b3-216">図 9 および 10 は、ユーザー入力が無効のために発生した例外を処理するために正常な方法を表示します。</span><span class="sxs-lookup"><span data-stu-id="470b3-216">Figures 9 and 10 show a graceful way to handle exceptions raised due to invalid user input.</span></span> <span data-ttu-id="470b3-217">理想的には、ただし、このような無効な入力は、決してリーチ、ビジネス ロジック層最初の段階で、ASP.NET ページを呼び出す前に、ユーザーの入力が有効なことを確認する必要があります、`ProductsBLL`クラスの`UpdateProduct`メソッド。</span><span class="sxs-lookup"><span data-stu-id="470b3-217">Ideally, though, such invalid input will never reach the Business Logic Layer in the first place, as the ASP.NET page should ensure that the user's inputs are valid before invoking the `ProductsBLL` class's `UpdateProduct` method.</span></span> <span data-ttu-id="470b3-218">ビジネス ロジック層に送信されたデータを確実に編集および挿入インターフェイスに検証コントロールを追加する方法を見て、次のチュートリアルでは、ビジネス ルールに準拠しています。</span><span class="sxs-lookup"><span data-stu-id="470b3-218">In our next tutorial we'll see how to add validation controls to the editing and inserting interfaces to ensure that the data submitted to the Business Logic Layer conforms to the business rules.</span></span> <span data-ttu-id="470b3-219">検証コントロールの呼び出しを防ぐだけでなく、`UpdateProduct`メソッドまで、ユーザーが指定したデータが有効ですが、データ エントリの問題を識別するためも、ユーザー エクスペリエンスをより多くの情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="470b3-219">The validation controls not only prevent the invocation of the `UpdateProduct` method until the user-supplied data is valid, but also provide a more informative user experience for identifying data entry problems.</span></span>


## <a name="step-3-gracefully-handling-bll-level-exceptions"></a><span data-ttu-id="470b3-220">手順 3: BLL レベルの例外を適切に処理します。</span><span class="sxs-lookup"><span data-stu-id="470b3-220">Step 3: Gracefully Handling BLL-Level Exceptions</span></span>

<span data-ttu-id="470b3-221">挿入すると、更新、またはデータの削除、データ アクセス層例外がスローされるデータに関連するエラーが発生した場合。</span><span class="sxs-lookup"><span data-stu-id="470b3-221">When inserting, updating, or deleting data, the Data Access Layer may throw an exception in the face of a data-related error.</span></span> <span data-ttu-id="470b3-222">データベースがオフラインである、必要なデータベース テーブルの列に指定すると、値をなかった可能性があります。 またはテーブル レベル制約が違反している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="470b3-222">The database may be offline, a required database table column might not have had a value specified, or a table-level constraint may have been violated.</span></span> <span data-ttu-id="470b3-223">厳密にデータ関連の例外に加えて、ビジネス ロジック層は、ビジネス ルールに違反しているときを示す例外を使用できます。</span><span class="sxs-lookup"><span data-stu-id="470b3-223">In addition to strictly data-related exceptions, the Business Logic Layer can use exceptions to indicate when business rules have been violated.</span></span> <span data-ttu-id="470b3-224">[ビジネス ロジック層を作成する](../introduction/creating-a-business-logic-layer-vb.md)チュートリアルでは、たとえば、ビジネス ルールのチェックを元に追加されます。`UpdateProduct`オーバー ロードします。</span><span class="sxs-lookup"><span data-stu-id="470b3-224">In the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-vb.md) tutorial, for example, we added a business rule check to the original `UpdateProduct` overload.</span></span> <span data-ttu-id="470b3-225">具体的には、ユーザーは、廃止として製品をマークが場合製品いないも必要その供給業者によって提供される 1 つだけ。</span><span class="sxs-lookup"><span data-stu-id="470b3-225">Specifically, if the user was marking a product as discontinued, we required that the product not be the only one provided by its supplier.</span></span> <span data-ttu-id="470b3-226">この条件に違反していた場合、`ApplicationException`がスローされました。</span><span class="sxs-lookup"><span data-stu-id="470b3-226">If this condition was violated, an `ApplicationException` was thrown.</span></span>

<span data-ttu-id="470b3-227">`UpdateProduct`オーバー ロードは、このチュートリアルで作成、禁止するビジネス規則を追加して、`UnitPrice`フィールドを元の 2 倍以上である新しい値に設定されてから`UnitPrice`値。</span><span class="sxs-lookup"><span data-stu-id="470b3-227">For the `UpdateProduct` overload created in this tutorial, let's add a business rule that prohibits the `UnitPrice` field from being set to a new value that's more than twice the original `UnitPrice` value.</span></span> <span data-ttu-id="470b3-228">これを行うには、調整、`UpdateProduct`オーバー ロードするように、このチェックを実行し、スロー、`ApplicationException`規則に違反する場合。</span><span class="sxs-lookup"><span data-stu-id="470b3-228">To accomplish this, adjust the `UpdateProduct` overload so that it performs this check and throws an `ApplicationException` if the rule is violated.</span></span> <span data-ttu-id="470b3-229">更新されたメソッドが次に示します。</span><span class="sxs-lookup"><span data-stu-id="470b3-229">The updated method follows:</span></span>


[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample6.vb)]

<span data-ttu-id="470b3-230">この変更により、既存の価格に 2 回以上である価格の更新が発生、`ApplicationException`がスローされます。</span><span class="sxs-lookup"><span data-stu-id="470b3-230">With this change, any price update that is more than twice the existing price will cause an `ApplicationException` to be thrown.</span></span> <span data-ttu-id="470b3-231">この BLL 発生した、DAL から発生する例外と同様に`ApplicationException`検出され、gridview の処理は`RowUpdated`イベント ハンドラー。</span><span class="sxs-lookup"><span data-stu-id="470b3-231">Just like the exception raised from the DAL, this BLL-raised `ApplicationException` can be detected and handled in the GridView's `RowUpdated` event handler.</span></span> <span data-ttu-id="470b3-232">実際には、`RowUpdated`イベント ハンドラーのコードでは、書き込まれるが正しくこの例外を検出し、表示、`ApplicationException`の`Message`プロパティの値。</span><span class="sxs-lookup"><span data-stu-id="470b3-232">In fact, the `RowUpdated` event handler's code, as written, will correctly detect this exception and display the `ApplicationException`'s `Message` property value.</span></span> <span data-ttu-id="470b3-233">図 11 は、ユーザーがその現在の価格 19.95 ドルの 2 倍以上である、50.00 ドルに Chai の価格を更新しようとしたとき画面を示しています。</span><span class="sxs-lookup"><span data-stu-id="470b3-233">Figure 11 shows a screen shot when a user attempts to update the price of Chai to $50.00, which is more than double its current price of $19.95.</span></span>


<span data-ttu-id="470b3-234">[![ビジネス ルールは、製品の価格が 2 倍以上の価格の上昇を禁止します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="470b3-234">[![The Business Rules Disallow Price Increases That More Than Double a Product's Price](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image29.png)</span></span>

<span data-ttu-id="470b3-235">**図 11**: ビジネス ルールの製品の価格が 2 倍以上 Disallow 価格の上昇 ([フルサイズの画像を表示する をクリックします](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image31.png))。</span><span class="sxs-lookup"><span data-stu-id="470b3-235">**Figure 11**: The Business Rules Disallow Price Increases That More Than Double a Product's Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image31.png))</span></span>


> [!NOTE]
> <span data-ttu-id="470b3-236">理想的には、ビジネス ロジック ルール リファクタリングのうち、`UpdateProduct`メソッドのオーバー ロードと共通のメソッドにします。</span><span class="sxs-lookup"><span data-stu-id="470b3-236">Ideally our business logic rules would be refactored out of the `UpdateProduct` method overloads and into a common method.</span></span> <span data-ttu-id="470b3-237">これについては、リーダーの演習として残してください。</span><span class="sxs-lookup"><span data-stu-id="470b3-237">This is left as an exercise for the reader.</span></span>


## <a name="summary"></a><span data-ttu-id="470b3-238">まとめ</span><span class="sxs-lookup"><span data-stu-id="470b3-238">Summary</span></span>

<span data-ttu-id="470b3-239">挿入、更新、および削除の各操作、データ Web コントロールと ObjectDataSource の関連するイベントを発生させる前と後のレベルをブックエンド実際の操作。</span><span class="sxs-lookup"><span data-stu-id="470b3-239">During inserting, updating, and deleting operations, both the data Web control and the ObjectDataSource involved fire pre- and post-level events that bookend the actual operation.</span></span> <span data-ttu-id="470b3-240">説明したようにこのチュートリアルで前のものでは、編集可能な GridView を使用する場合、GridView の`RowUpdating`ObjectDataSource の後にイベントの起動`Updating`この時点で、更新コマンドが ObjectDataSource に加えられたイベント基になるオブジェクト。</span><span class="sxs-lookup"><span data-stu-id="470b3-240">As we saw in this tutorial and the preceding one, when working with an editable GridView the GridView's `RowUpdating` event fires, followed by the ObjectDataSource's `Updating` event, at which point the update command is made to the ObjectDataSource's underlying object.</span></span> <span data-ttu-id="470b3-241">操作が完了すると、ObjectDataSource の`Updated`イベントの起動後に、GridView の`RowUpdated`イベント。</span><span class="sxs-lookup"><span data-stu-id="470b3-241">After the operation has completed, the ObjectDataSource's `Updated` event fires, followed by the GridView's `RowUpdated` event.</span></span>

<span data-ttu-id="470b3-242">入力パラメーターをカスタマイズするために事前にレベルのイベントまたは投稿レベルのイベントを検査し、操作の結果に応答するために、イベント ハンドラーを作成できます。</span><span class="sxs-lookup"><span data-stu-id="470b3-242">We can create event handlers for the pre-level events in order to customize the input parameters or for the post-level events in order to inspect and respond to the operation's results.</span></span> <span data-ttu-id="470b3-243">後のレベルのイベント ハンドラーは、操作中に例外が発生したかどうかを検出するために最もよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="470b3-243">Post-level event handlers are most commonly used to detect whether an exception occurred during the operation.</span></span> <span data-ttu-id="470b3-244">例外が発生した場合、これらの投稿レベルのイベント ハンドラーは、独自の例外を必要に応じて処理できます。</span><span class="sxs-lookup"><span data-stu-id="470b3-244">In the face of an exception, these post-level event handlers can optionally handle the exception on their own.</span></span> <span data-ttu-id="470b3-245">このチュートリアルでは、わかりやすいエラー メッセージを表示することでこのような例外を処理する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="470b3-245">In this tutorial we saw how to handle such an exception by displaying a friendly error message.</span></span>

<span data-ttu-id="470b3-246">次のチュートリアルではデータの書式設定に関する問題によって発生した例外が発生する可能性を低減するための方法を見ていきます (、負の値を入力するなど`UnitPrice`)。</span><span class="sxs-lookup"><span data-stu-id="470b3-246">In the next tutorial we'll see how to lessen the likelihood of exceptions arising from data formatting issues (such as entering a negative `UnitPrice`).</span></span> <span data-ttu-id="470b3-247">具体的には、編集および挿入インターフェイスに検証コントロールを追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="470b3-247">Specifically, we'll look at how to add validation controls to the editing and inserting interfaces.</span></span>

<span data-ttu-id="470b3-248">満足のプログラミングです。</span><span class="sxs-lookup"><span data-stu-id="470b3-248">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="470b3-249">執筆者紹介</span><span class="sxs-lookup"><span data-stu-id="470b3-249">About the Author</span></span>

<span data-ttu-id="470b3-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)、7 つ受け取りますブックおよびの創設者の著者[4GuysFromRolla.com](http://www.4guysfromrolla.com)、Microsoft Web テクノロジと 1998 年から携わっています。</span><span class="sxs-lookup"><span data-stu-id="470b3-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="470b3-251">Scott は、フリーのコンサルタント、トレーナー、およびライターとして動作します。</span><span class="sxs-lookup"><span data-stu-id="470b3-251">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="470b3-252">最新の著書は[ *Sams 教える自分で ASP.NET 2.0 24 時間以内に*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)します。</span><span class="sxs-lookup"><span data-stu-id="470b3-252">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="470b3-253">彼に到達できる[mitchell@4GuysFromRolla.comします。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="470b3-253">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="470b3-254">彼のブログにあるでまたは[ http://ScottOnWriting.NET](http://ScottOnWriting.NET)します。</span><span class="sxs-lookup"><span data-stu-id="470b3-254">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="470b3-255">特別なに感謝します。</span><span class="sxs-lookup"><span data-stu-id="470b3-255">Special Thanks To</span></span>

<span data-ttu-id="470b3-256">このチュートリアル シリーズは、多くの便利なレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="470b3-256">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="470b3-257">このチュートリアルでは、潜在顧客レビュー担当者は、Liz Shulok でした。</span><span class="sxs-lookup"><span data-stu-id="470b3-257">Lead reviewer for this tutorial was Liz Shulok.</span></span> <span data-ttu-id="470b3-258">今後、MSDN の記事を確認したいですか。</span><span class="sxs-lookup"><span data-stu-id="470b3-258">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="470b3-259">場合は、筆者に[mitchell@4GuysFromRolla.comします。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="470b3-259">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="470b3-260">[前へ](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md)
> [次へ](adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)</span><span class="sxs-lookup"><span data-stu-id="470b3-260">[Previous](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md)
[Next](adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)</span></span>
